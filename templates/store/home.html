{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}TRANG CHỦ - QHUN22 Mobile{% endblock %}

{% block content %}
<style>
/* Product Card - Clean Layout */
.qh-product-card {
    background: var(--qh-card-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.3s, box-shadow 0.3s;
}
.qh-product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}
.qh-product-card.out-of-stock {
    opacity: 0.75;
}

/* Discount Ribbon  */
.discount-badge {
    position: absolute;
    top: 0;
    left: 0;
    background: #ef4444;
    color: white;
    padding: 6px 12px;
    font-size: 14px;
    font-weight: 700;
    z-index: 10;
    border-radius: 0 0 8px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    line-height: 1;
}
.discount-badge::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 0;
    width: 0;
    height: 0;
    border-left: 10px solid #ef4444;
    border-bottom: 6px solid transparent;
}

/* Wishlist Heart Button */
.wishlist-btn {
    position: absolute;
    top: 14px;
    right: 14px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    z-index: 10;
    opacity: 0;
    transform: scale(0.8);
}
.qh-product-card:hover .wishlist-btn {
    opacity: 1;
    transform: scale(1);
}
.wishlist-btn svg {
    width: 20px;
    height: 20px;
    stroke: #6b7280;
    fill: none;
    transition: all 0.3s ease;
}
.wishlist-btn:hover svg {
    stroke: #ef4444;
    transform: scale(1.1);
}
.wishlist-btn.liked svg {
    stroke: #ef4444;
    fill: #ef4444;
}

/* Out of Stock Overlay */
.out-of-stock-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 5;
}
.out-of-stock-badge {
    position: absolute;
    top: 14px;
    left: 14px;
    background: #6b7280;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 6;
}

/* Compare Button */
.qh-compare-btn {
    font-family: 'Signika', sans-serif;
}
.qh-compare-btn:hover {
    background: var(--qh-primary) !important;
    border-color: var(--qh-primary) !important;
    color: var(--qh-text) !important;
}
.qh-compare-btn.active {
    background: var(--qh-primary) !important;
    border-color: var(--qh-primary-dark) !important;
    color: var(--qh-text) !important;
    font-weight: 600;
}
</style>

<div class="qh-home">
    
    {% if products %}
    <!-- Product Grid: 5 products per row -->
    <div class="qh-product-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 40px;">
        {% for product in products %}
        <a href="{% url 'store:product_detail' product.id %}" class="qh-product-card {% if product.stock == 0 %}out-of-stock{% endif %}" style="text-decoration: none; color: inherit; display: block;">
            
            <!-- Product Image -->
            <div class="qh-product-image" style="position: relative; aspect-ratio: 1; background: #f5f5f5; overflow: visible;">
                
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--qh-text-light);">
                    <svg style="width: 64px; height: 64px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
                {% endif %}
                
                <!-- Discount Badge -->
                {% if product.detail and product.detail.summary_original_price and product.detail.summary_original_price > product.detail.discounted_price and product.detail.summary_discount_percent > 0 %}
                <div class="discount-badge">
                    -{{ product.detail.summary_discount_percent }}%
                </div>
                {% endif %}
                
                <!-- Wishlist Heart Button -->
                {% if product.id in wishlist_product_ids %}
                <button class="wishlist-btn liked" data-product-id="{{ product.id }}" onclick="toggleWishlist(this, {{ product.id }}); return false;">
                {% else %}
                <button class="wishlist-btn" data-product-id="{{ product.id }}" onclick="toggleWishlist(this, {{ product.id }}); return false;">
                {% endif %}
                    <svg viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                </button>
                
                <!-- Out of Stock Overlay (chỉ hiển thị overlay mờ, không hiển thị badge) -->
                {% if product.stock == 0 %}
                <div class="out-of-stock-overlay"></div>
                {% endif %}
            </div>
            
            <!-- Product Info -->
            <div class="qh-product-info" style="padding: 14px;">
                <!-- Product Name -->
                <h3 class="qh-product-name" style="font-size: 18px; font-weight: 600; color: var(--qh-text); margin-bottom: 10px; line-height: 1.4; height: 25px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                    {{ product.name }}
                </h3>
                
                <!-- Price -->
                <div class="qh-product-price" style="margin-bottom: 10px;">
                    {% if product.detail and product.detail.summary_original_price and product.detail.summary_original_price > product.detail.discounted_price and product.detail.summary_discount_percent > 0 %}
                    <span style="font-size: 14px; color: var(--qh-text-light); text-decoration: line-through; display: block; margin-bottom: 2px;">
                        {{ product.detail.summary_original_price|format_price_with_unit }}
                    </span>
                    <span style="font-size: 18px; font-weight: 700; color: var(--qh-primary);">
                        {{ product.detail.discounted_price|format_price_with_unit }}
                    </span>
                    {% else %}
                    <span style="font-size: 18px; font-weight: 700; color: var(--qh-primary);">
                        {% if product.detail %}{{ product.detail.discounted_price|format_price_with_unit }}{% else %}{{ product.price|format_price_with_unit }}{% endif %}
                    </span>
                    {% endif %}
                </div>
                
                <!-- Status Row -->
                <div style="display: flex; gap: 6px; margin-bottom: 12px;">
                    {% if product.stock > 0 %}
                    <span style="font-size: 13px; color: #10b981; font-weight: 600; background: #d1fae5; padding: 4px 8px; border-radius: 4px; flex: 1; text-align: center;">
                        Còn hàng
                    </span>
                    <span style="font-size: 13px; color: #f59e0b; font-weight: 600; background: #fef3c7; padding: 4px 8px; border-radius: 4px; flex: 1; text-align: center;">
                        Trả góp 0%
                    </span>
                    {% else %}
                    <span style="font-size: 13px; color: #ef4444; font-weight: 600; background: #fee2e2; padding: 4px 8px; border-radius: 4px; flex: 1; text-align: center;">
                        Hết hàng
                    </span>
                    {% endif %}
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 6px;">
                    <button class="qh-btn qh-btn-outline qh-compare-btn"
                            data-product-id="{{ product.id }}"
                            data-product-name="{{ product.name }}"
                            data-product-image="{% if product.image %}{{ product.image.url }}{% else %}{% endif %}"
                            data-product-price="{% if product.detail %}{{ product.detail.discounted_price|format_price_with_unit }}{% else %}{{ product.price|format_price_with_unit }}{% endif %}"
                            onclick="event.preventDefault();event.stopPropagation();QHCompare.addToCompare({{ product.id }}, this.dataset.productName, this.dataset.productImage, this.dataset.productPrice)"
                            style="flex: 1; padding: 8px 4px; font-size: 14px; border: 1px solid var(--qh-border); background: transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s; display:flex; align-items:center; justify-content:center; gap:4px;">
                        <i class="ri-arrow-left-right-line"></i> So sánh
                    </button>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if products.has_other_pages %}
    <div class="qh-pagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 40px;">
        {% if products.has_previous %}
        <a href="?page={{ products.previous_page_number }}" class="qh-btn qh-btn-secondary" style="padding: 8px 16px;">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        {% endif %}
        
        {% for num in products.paginator.page_range %}
            {% if products.number == num %}
            <span class="qh-btn qh-btn-primary" style="padding: 8px 16px; cursor: default;">{{ num }}</span>
            {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
            <a href="?page={{ num }}" class="qh-btn qh-btn-secondary" style="padding: 8px 16px;">{{ num }}</a>
            {% endif %}
        {% endfor %}
        
        {% if products.has_next %}
        <a href="?page={{ products.next_page_number }}" class="qh-btn qh-btn-secondary" style="padding: 8px 16px;">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </a>
        {% endif %}
    </div>
    {% endif %}
    
    {% else %}
    <div class="qh-card" style="padding: 60px; text-align: center;">
        <svg style="width: 80px; height: 80px; color: var(--qh-text-light); margin-bottom: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
        </svg>
        <h3 style="color: var(--qh-text); margin-bottom: 12px;">Chưa có sản phẩm nào</h3>
        <p style="color: var(--qh-text-light);">Hệ thống đang cập nhật sản phẩm mới. Bạn vui lòng quay lại sau nhé!</p>
    </div>
    {% endif %}
</div>

<!-- Wishlist Toggle JavaScript -->
<script>
function updateWishlistBadge(count) {
    const badge = document.getElementById('qh-wishlist-count');
    if (badge) {
        badge.textContent = count;
    }
}

function toggleWishlist(button, productId) {
    fetch('{% url "store:wishlist_toggle" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'product_id=' + productId
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Toggle class liked
            if (data.is_liked) {
                button.classList.add('liked');
            } else {
                button.classList.remove('liked');
            }
            // Cập nhật số lượng wishlist trên header
            updateWishlistBadge(data.total_wishlist);
            // Hiển thị toast thông báo
            if (window.QHToast) {
                QHToast.show(data.message, 'success');
            }
        } else if (data.require_login) {
            // Chuyển hướng đến trang đăng nhập với QHConfirm
            if (window.QHConfirm) {
                QHConfirm.show(data.message + '. Bạn có muốn đăng nhập không?', function() {
                    window.location.href = '{% url "store:login" %}';
                });
            } else {
                if (confirm(data.message + '. Bạn có muốn đăng nhập không?')) {
                    window.location.href = '{% url "store:login" %}';
                }
            }
        } else {
            // Hiển thị lỗi
            if (window.QHToast) {
                QHToast.show(data.message, 'error');
            } else {
                alert(data.message);
            }
            // Revert trạng thái nếu có lỗi
            if (data.is_liked) {
                button.classList.remove('liked');
            } else {
                button.classList.add('liked');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (window.QHToast) {
            QHToast.show('Có lỗi xảy ra. Vui lòng thử lại.', 'error');
        } else {
            alert('Có lỗi xảy ra. Vui lòng thử lại.');
        }
    });
}
</script>

<!-- USP Section -->
<section class="qh-usp-section">
    <div class="qh-usp-container">
        <h2 class="qh-usp-title">TẠI SAO CHỌN QHUN22 MOBILE?</h2>
        <div class="qh-usp-grid">
            <div class="qh-usp-card">
                <div class="qh-usp-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                </div>
                <h3 class="qh-usp-card-title">Hàng Chính Hãng</h3>
                <p class="qh-usp-card-desc">Cam kết 100% sản phẩm chính hãng, đầy đủ phụ kiện.</p>
            </div>
            <div class="qh-usp-card">
                <div class="qh-usp-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </div>
                <h3 class="qh-usp-card-title">Đổi Trả Dễ Dàng</h3>
                <p class="qh-usp-card-desc">Hỗ trợ đổi trả trong 7 ngày nếu lỗi kỹ thuật.</p>
            </div>
            <div class="qh-usp-card">
                <div class="qh-usp-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <h3 class="qh-usp-card-title">Giao Hàng Nhanh</h3>
                <p class="qh-usp-card-desc">Giao hàng toàn quốc từ 1-2 ngày làm việc.</p>
            </div>
            <div class="qh-usp-card">
                <div class="qh-usp-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                    </svg>
                </div>
                <h3 class="qh-usp-card-title">Bảo Hành Uy Tín</h3>
                <p class="qh-usp-card-desc">Bảo hành chính hãng từ 6-12 tháng.</p>
            </div>
        </div>
    </div>
</section>

{% endblock %}
