{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}TÀI KHOẢN - QHUN22 Mobile{% endblock %}

{% block content %}
<style>
/* ==================== PROFILE PAGE ==================== */
.qh-profile-page {
    /* Inherits from .qh-main */
}

/* ---- User Info Card (top) ---- */
.qh-pf-info-card {
    background: var(--qh-white);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    padding: 28px 32px;
    display: flex;
    align-items: center;
    gap: 0;
    margin-bottom: 16px;
}

/* Avatar + Basic Info */
.qh-pf-user {
    display: flex;
    align-items: center;
    gap: 20px;
    min-width: 260px;
    padding-right: 28px;
    border-right: 1px solid var(--qh-border);
}
.qh-pf-avatar {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    border: 1.5px solid var(--qh-border);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.qh-pf-avatar svg {
    width: 24px;
    height: 24px;
    color: var(--qh-text-light);
}
.qh-pf-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--qh-text);
    margin-bottom: 2px;
}
.qh-pf-detail {
    font-size: 14px;
    color: var(--qh-text-light);
    line-height: 1.6;
}

/* Stats */
.qh-pf-stats {
    display: flex;
    align-items: center;
    flex: 1;
    gap: 0;
}
.qh-pf-stat {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 0 20px;
    border-right: 1px solid var(--qh-border);
}
.qh-pf-stat:last-child {
    border-right: none;
}
.qh-pf-stat-icon {
    width: 48px;
    height: 48px;
    border: 1.5px solid var(--qh-border);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    line-height: 1;
    color: var(--qh-text-light);
    font-size: 24px;
}
.qh-pf-stat-icon i {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    line-height: 1;
}
.qh-pf-stat-content {
    display: flex;
    flex-direction: column;
}
.qh-pf-stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--qh-text);
    line-height: 1.3;
}
.qh-pf-stat-label {
    font-size: 13px;
    color: var(--qh-text-light);
    margin-top: 2px;
    white-space: nowrap;
}

/* Rank Badge */
.qh-pf-rank-icon {
    width: 48px;
    height: 48px;
    border: 1.5px solid var(--qh-border);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    line-height: 1;
    font-size: 24px;
}
.qh-pf-rank-icon i {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    line-height: 1;
}
.qh-pf-rank-icon.bronze { color: #b87333; }
.qh-pf-rank-icon.silver { color: #9ca3af; }
.qh-pf-rank-icon.gold   { color: #f59e0b; }
.qh-pf-rank-icon.diamond { color: #3b82f6; }
.qh-pf-rank-label {
    font-size: 15px;
    font-weight: 600;
}
.qh-pf-rank-label.bronze { color: #b87333; }
.qh-pf-rank-label.silver { color: #9ca3af; }
.qh-pf-rank-label.gold   { color: #f59e0b; }
.qh-pf-rank-label.diamond { color: #3b82f6; }

/* Logout Button in top card */
.qh-pf-logout-section {
    padding-left: 24px;
    flex-shrink: 0;
}
.qh-pf-logout-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 12px 20px;
    background: transparent;
    border: 1px solid var(--qh-border);
    border-radius: 10px;
    cursor: pointer;
    color: var(--qh-text-light);
    font-family: 'Signika', sans-serif;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    text-decoration: none;
}
.qh-pf-logout-btn:hover {
    border-color: #ef4444;
    color: #ef4444;
    background: #fef2f2;
}
.qh-pf-logout-btn svg {
    width: 28px;
    height: 28px;
}

/* ---- Tab Navigation ---- */
.qh-pf-tabs {
    background: var(--qh-white);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    padding: 0 16px;
    display: flex;
    align-items: center;
    gap: 0;
    overflow-x: auto;
    margin-bottom: 24px;
}
.qh-pf-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 18px 24px;
    font-size: 15px;
    font-weight: 500;
    color: var(--qh-text-light);
    text-decoration: none;
    white-space: nowrap;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
}
.qh-pf-tab:hover {
    color: var(--qh-text);
    background: var(--qh-bg);
}
.qh-pf-tab.active {
    color: var(--qh-primary-dark);
    border-bottom-color: var(--qh-primary);
    font-weight: 600;
}
.qh-pf-tab svg,
.qh-pf-tab i {
    width: 20px;
    height: 20px;
    font-size: 20px;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    vertical-align: middle;
}

/* ---- Tab Content Area ---- */
.qh-pf-content {
    background: var(--qh-white);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    padding: 32px;
    min-height: 200px;
}
.qh-pf-tab-panel {
    display: none;
}
.qh-pf-tab-panel.active {
    display: block;
}

/* Empty state inside tab */
.qh-pf-empty {
    text-align: center;
    padding: 40px 0;
}
.qh-pf-empty svg {
    width: 80px;
    height: 80px;
    color: #d1d5db;
    margin-bottom: 16px;
}
.qh-pf-empty h3 {
    font-size: 20px;
    font-weight: 600;
    color: var(--qh-text);
    margin-bottom: 8px;
}
.qh-pf-empty p {
    font-size: 15px;
    color: var(--qh-text-light);
    margin-bottom: 20px;
}

/* ---- Address Book ---- */
.qh-pf-addr-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
}
.qh-pf-addr-section {
    display: flex;
    flex-direction: column;
}
.qh-pf-addr-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--qh-text);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.qh-pf-addr-title i {
    font-size: 20px;
    color: var(--qh-primary);
}
.qh-pf-addr-form .qh-form-group {
    margin-bottom: 16px;
}
.qh-pf-addr-form .qh-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}
.qh-pf-addr-form select.qh-input {
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
    cursor: pointer;
}
.qh-pf-addr-form .qh-addr-checkbox-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
}
.qh-pf-addr-form .qh-addr-checkbox-row input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--qh-primary);
    cursor: pointer;
}
.qh-pf-addr-form .qh-addr-checkbox-row label {
    font-size: 14px;
    color: var(--qh-text);
    cursor: pointer;
    user-select: none;
}

/* Address List */
.qh-pf-addr-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.qh-pf-addr-card {
    border: 1.5px solid var(--qh-border);
    border-radius: 10px;
    padding: 16px;
    position: relative;
    transition: all 0.2s;
}
.qh-pf-addr-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.qh-pf-addr-card.is-default {
    border-color: var(--qh-primary);
    background: rgba(169, 204, 240, 0.05);
}
.qh-pf-addr-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}
.qh-pf-addr-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--qh-text);
}
.qh-pf-addr-phone {
    font-size: 14px;
    color: var(--qh-text-light);
    margin-left: 8px;
}
.qh-pf-addr-default-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    background: var(--qh-primary);
    color: white;
}
.qh-pf-addr-detail {
    font-size: 13px;
    color: var(--qh-text-light);
    line-height: 1.5;
    margin-bottom: 10px;
}
.qh-pf-addr-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}
.qh-pf-addr-actions button {
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--qh-border);
    background: white;
    color: var(--qh-text);
    font-family: 'Signika', sans-serif;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
}
.qh-pf-addr-actions button:hover {
    border-color: var(--qh-primary);
    color: var(--qh-primary);
}
.qh-pf-addr-actions button.qh-addr-del:hover {
    border-color: #ef4444;
    color: #ef4444;
    background: #fef2f2;
}
.qh-pf-addr-actions button.qh-addr-set-default {
    border-color: var(--qh-primary);
    color: var(--qh-primary);
}
.qh-pf-addr-actions button.qh-addr-set-default:hover {
    background: var(--qh-primary);
    color: white;
}
@media (max-width: 768px) {
    .qh-pf-addr-grid {
        grid-template-columns: 1fr;
        gap: 24px;
    }
    .qh-pf-addr-form .qh-form-row {
        grid-template-columns: 1fr;
    }
}

/* ---- Change Password Form ---- */
.qh-pf-pw-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
}
.qh-pf-pw-section {
    display: flex;
    flex-direction: column;
}
.qh-pf-pw-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--qh-text);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.qh-pf-pw-title i {
    font-size: 20px;
    color: var(--qh-primary);
}
.qh-pf-form {
    max-width: 100%;
}
.qh-pf-form .qh-form-group {
    margin-bottom: 20px;
}

/* Password History */
.qh-pf-pw-history {
    display: flex;
    flex-direction: column;
    gap: 0;
}
.qh-pf-pw-pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid var(--qh-border);
}
.qh-pf-pw-page-btn {
    width: 32px;
    height: 32px;
    border: 1px solid var(--qh-border);
    border-radius: 6px;
    background: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 500;
    color: var(--qh-text);
    font-family: 'Signika', sans-serif;
    transition: all 0.2s;
}
.qh-pf-pw-page-btn:hover {
    border-color: var(--qh-primary);
    color: var(--qh-primary);
}
.qh-pf-pw-page-btn.active {
    background: var(--qh-primary);
    border-color: var(--qh-primary);
    color: white;
}
.qh-pf-pw-page-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}
.qh-pf-pw-page-btn:disabled:hover {
    border-color: var(--qh-border);
    color: var(--qh-text);
}
.qh-pf-pw-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 0;
    border-bottom: 1px solid var(--qh-border);
}
.qh-pf-pw-item:last-child {
    border-bottom: none;
}
.qh-pf-pw-item-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #d1fae5;
    color: #059669;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 16px;
}
.qh-pf-pw-item-info {
    flex: 1;
    min-width: 0;
}
.qh-pf-pw-item-date {
    font-size: 14px;
    font-weight: 600;
    color: var(--qh-text);
}
.qh-pf-pw-item-detail {
    font-size: 12px;
    color: var(--qh-text-light);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
@media (max-width: 768px) {
    .qh-pf-pw-grid {
        grid-template-columns: 1fr;
        gap: 24px;
    }
}

/* ---- Order History (inside tab) ---- */
.qh-pf-order {
    border: 1px solid var(--qh-border);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: box-shadow 0.2s;
}
.qh-pf-order:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.qh-pf-order:last-child {
    margin-bottom: 0;
}
.qh-pf-order-left {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.qh-pf-order-id {
    font-size: 16px;
    font-weight: 600;
    color: var(--qh-text);
}
.qh-pf-order-id span {
    color: var(--qh-primary-dark);
}
.qh-pf-order-date {
    font-size: 13px;
    color: var(--qh-text-light);
}
.qh-pf-order-product {
    font-size: 13px;
    color: var(--qh-text);
    max-width: 340px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.qh-pf-order-more {
    font-size: 12px;
    color: var(--qh-primary-dark);
    font-style: italic;
}
.qh-pf-order-right {
    display: flex;
    align-items: center;
    gap: 16px;
}
.qh-pf-order-amount {
    font-size: 17px;
    font-weight: 700;
    color: #dc2626;
}

/* Status badge (reuse order tracking) */
.qh-pf-status {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}
.qh-pf-status.awaiting_payment { background: #fef9c3; color: #854d0e; }
.qh-pf-status.pending    { background: #fef3c7; color: #d97706; }
.qh-pf-status.processing { background: #dbeafe; color: #2563eb; }
.qh-pf-status.shipped    { background: #e0e7ff; color: #4f46e5; }
.qh-pf-status.delivered  { background: #d1fae5; color: #059669; }
.qh-pf-status.cancelled  { background: #fee2e2; color: #dc2626; }

/* ---- Responsive ---- */
@media (max-width: 1024px) {
    .qh-pf-info-card {
        flex-wrap: wrap;
        gap: 20px;
    }
    .qh-pf-user {
        border-right: none;
        padding-right: 0;
        min-width: unset;
        flex: 1 1 100%;
    }
    .qh-pf-stats {
        flex: 1 1 100%;
    }
    .qh-pf-logout-section {
        padding-left: 0;
        flex: 1 1 100%;
        display: flex;
        justify-content: center;
    }
    .qh-pf-logout-btn {
        flex-direction: row;
        width: 100%;
        justify-content: center;
    }
}
@media (max-width: 768px) {
    .qh-pf-info-card {
        padding: 20px;
    }
    .qh-pf-stats {
        flex-wrap: wrap;
    }
    .qh-pf-stat {
        flex: 1 1 50%;
        padding: 12px 8px;
        border-right: none;
        border-bottom: 1px solid var(--qh-border);
    }
    .qh-pf-tab {
        padding: 14px 16px;
        font-size: 14px;
    }
    .qh-pf-content {
        padding: 20px;
    }
    .qh-pf-order {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    .qh-pf-order-right {
        width: 100%;
        justify-content: space-between;
    }
}
</style>

<div class="qh-profile-page">

    <!-- ====== USER INFO CARD ====== -->
    <div class="qh-pf-info-card">
        <!-- Avatar + Info -->
        <div class="qh-pf-user">
            <div class="qh-pf-avatar">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
            </div>
            <div>
                <div class="qh-pf-name">
                    {% if user.last_name %}{{ user.last_name }}{% else %}{{ user.email }}{% endif %}
                </div>
                <div class="qh-pf-detail">
                    {% if user.phone %}{{ user.phone }}<br>{% endif %}
                    {{ user.email }}
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="qh-pf-stats">
            <div class="qh-pf-stat">
                <div class="qh-pf-stat-icon"><i class="ri-shopping-bag-3-line"></i></div>
                <div class="qh-pf-stat-content">
                    <div class="qh-pf-stat-value">{{ total_orders|default:"0" }}</div>
                    <div class="qh-pf-stat-label">Tổng số đơn hàng đã mua</div>
                </div>
            </div>
            <div class="qh-pf-stat">
                <div class="qh-pf-stat-icon"><i class="ri-money-dollar-circle-line"></i></div>
                <div class="qh-pf-stat-content">
                    <div class="qh-pf-stat-value">{{ total_spent|default:"0" }}đ</div>
                    <div class="qh-pf-stat-label">Tổng số tiền đã tiêu dùng</div>
                </div>
            </div>
            <div class="qh-pf-stat">
                {% if total_spent_raw >= 50000000 %}
                <div class="qh-pf-rank-icon diamond"><i class="ri-vip-diamond-fill"></i></div>
                <div class="qh-pf-stat-content"><div class="qh-pf-rank-label diamond">Hạng: Kim cương</div></div>
                {% elif total_spent_raw >= 20000000 %}
                <div class="qh-pf-rank-icon gold"><i class="ri-medal-fill"></i></div>
                <div class="qh-pf-stat-content"><div class="qh-pf-rank-label gold">Hạng: Vàng</div></div>
                {% elif total_spent_raw >= 5000000 %}
                <div class="qh-pf-rank-icon silver"><i class="ri-shield-star-fill"></i></div>
                <div class="qh-pf-stat-content"><div class="qh-pf-rank-label silver">Hạng: Bạc</div></div>
                {% else %}
                <div class="qh-pf-rank-icon bronze"><i class="ri-copper-coin-fill"></i></div>
                <div class="qh-pf-stat-content"><div class="qh-pf-rank-label bronze">Hạng: Đồng</div></div>
                {% endif %}
            </div>
        </div>

        <!-- Logout -->
        <div class="qh-pf-logout-section">
            <a href="{% url 'account_logout' %}" class="qh-pf-logout-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                Đăng xuất
            </a>
        </div>
    </div>

    <!-- ====== TAB NAVIGATION ====== -->
    <div class="qh-pf-tabs">
        <!-- Admin Dashboard -->
        {% if user.is_superuser %}
        <a href="{% url 'store:dashboard' %}" class="qh-pf-tab">
            <i class="ri-dashboard-line"></i>
            Dashboard
        </a>
        {% endif %}

        <a href="#" class="qh-pf-tab active" data-tab="address">
            <i class="ri-map-pin-line"></i>
            Sổ địa chỉ
        </a>
        <a href="#" class="qh-pf-tab" data-tab="coupon">
            <i class="ri-coupon-3-line"></i>
            Mã giảm giá
        </a>
        <a href="#" class="qh-pf-tab" data-tab="history">
            <i class="ri-file-list-3-line"></i>
            Lịch sử mua hàng
        </a>
        <a href="#" class="qh-pf-tab" data-tab="student">
            <i class="ri-map-pin-user-line"></i>
            Student - Teacher
        </a>
        <a href="#" class="qh-pf-tab" data-tab="password">
            <i class="ri-lock-password-line"></i>
            Đổi mật khẩu
        </a>
        <a href="#" class="qh-pf-tab" data-tab="refund">
            <i class="ri-refund-2-line"></i>
            Hoàn tiền
        </a>
    </div>

    <!-- ====== TAB CONTENT ====== -->
    <div class="qh-pf-content">

        <!-- Sổ địa chỉ -->
        <div class="qh-pf-tab-panel active" id="tab-address">
            <div class="qh-pf-addr-grid">
                <!-- Left: Add new address -->
                <div class="qh-pf-addr-section">
                    <div class="qh-pf-addr-title">
                        <i class="ri-add-circle-line"></i> Thêm địa chỉ mới
                    </div>
                    <form class="qh-pf-addr-form" id="addAddressForm" onsubmit="return submitAddress(event)">
                        {% csrf_token %}
                        <div class="qh-form-group qh-form-row">
                            <div>
                                <label class="qh-label">Họ tên</label>
                                <input type="text" name="full_name" class="qh-input" placeholder="Nhập họ tên" required>
                            </div>
                            <div>
                                <label class="qh-label">Số điện thoại</label>
                                <input type="text" name="phone" class="qh-input" placeholder="Nhập số điện thoại" required>
                            </div>
                        </div>
                        <div class="qh-form-group">
                            <label class="qh-label">Tỉnh/Thành phố</label>
                            <select name="province" class="qh-input" id="addrProvince" onchange="loadDistricts()" required>
                                <option value="">-- Chọn Tỉnh/Thành phố --</option>
                            </select>
                        </div>
                        <div class="qh-form-group qh-form-row">
                            <div>
                                <label class="qh-label">Quận/Huyện</label>
                                <select name="district" class="qh-input" id="addrDistrict" onchange="loadWards()" required disabled>
                                    <option value="">-- Chọn Quận/Huyện --</option>
                                </select>
                            </div>
                            <div>
                                <label class="qh-label">Phường/Xã</label>
                                <select name="ward" class="qh-input" id="addrWard" required disabled>
                                    <option value="">-- Chọn Phường/Xã --</option>
                                </select>
                            </div>
                        </div>
                        <div class="qh-form-group">
                            <label class="qh-label">Địa chỉ chi tiết</label>
                            <input type="text" name="detail" class="qh-input" placeholder="Số nhà, tên đường, tòa nhà..." required>
                        </div>
                        <div class="qh-addr-checkbox-row">
                            <input type="checkbox" id="addrDefault" name="is_default">
                            <label for="addrDefault">Đặt làm địa chỉ mặc định</label>
                        </div>
                        <button type="submit" class="qh-btn qh-btn-primary" id="addrSubmitBtn" style="width: 100%; font-size: 15px; font-weight: 600;">
                            <i class="ri-add-line" style="margin-right: 4px;"></i> Thêm địa chỉ
                        </button>
                    </form>
                </div>

                <!-- Right: Address list -->
                <div class="qh-pf-addr-section">
                    <div class="qh-pf-addr-title">
                        <i class="ri-map-pin-line"></i> Danh sách địa chỉ của bạn
                    </div>
                    <div class="qh-pf-addr-list" id="addressList">
                        {% if addresses %}
                            {% for addr in addresses %}
                            <div class="qh-pf-addr-card{% if addr.is_default %} is-default{% endif %}" id="addrCard_{{ addr.id }}" data-addr-index="{{ forloop.counter }}">
                                <div class="qh-pf-addr-card-header">
                                    <div>
                                        <span class="qh-pf-addr-name">{{ addr.full_name }}</span>
                                        <span class="qh-pf-addr-phone">{{ addr.phone }}</span>
                                    </div>
                                    {% if addr.is_default %}
                                    <span class="qh-pf-addr-default-badge"><i class="ri-check-line"></i> Mặc định</span>
                                    {% endif %}
                                </div>
                                <div class="qh-pf-addr-detail">
                                    {{ addr.detail }}, {{ addr.ward_name }}, {{ addr.district_name }}, {{ addr.province_name }}
                                </div>
                                <div class="qh-pf-addr-actions">
                                    {% if not addr.is_default %}
                                    <button class="qh-addr-set-default" onclick="setDefaultAddress({{ addr.id }})">
                                        <i class="ri-check-double-line"></i> Đặt mặc định
                                    </button>
                                    {% endif %}
                                    <button class="qh-addr-del" onclick="deleteAddress({{ addr.id }})">
                                        <i class="ri-delete-bin-line"></i> Xóa
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="qh-pf-empty" id="addrEmptyState">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:60px;height:60px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <h3 style="font-size:16px;">Chưa có địa chỉ nào</h3>
                                <p style="font-size:13px;">Thêm địa chỉ giao hàng ở bên trái nhé!</p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="qh-pf-pw-pagination" id="addrPagination"></div>
                </div>
            </div>
        </div>

        <!-- Mã giảm giá -->
        <div class="qh-pf-tab-panel" id="tab-coupon">
            <div class="qh-pf-empty">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                </svg>
                <h3>Chưa có mã giảm giá</h3>
                <p>Hãy theo dõi để nhận mã giảm giá hấp dẫn nhé!</p>
            </div>
        </div>

        <!-- Lịch sử mua hàng -->
        <div class="qh-pf-tab-panel" id="tab-history">
            {% if orders %}
                {% for order in orders %}
                <div class="qh-pf-order">
                    <div class="qh-pf-order-left">
                        <div class="qh-pf-order-id">Đơn hàng <span>#{{ order.order_code }}</span></div>
                        <div class="qh-pf-order-date">{{ order.created_at|date:"d/m/Y H:i" }}</div>
                        {% with first_item=order.items.first %}
                        {% if first_item %}
                        <div class="qh-pf-order-product">{{ first_item.product_name }}{% if order.items.count > 1 %} <span class="qh-pf-order-more">+{{ order.items.count|add:"-1" }} sản phẩm khác</span>{% endif %}</div>
                        {% endif %}
                        {% endwith %}
                    </div>
                    <div class="qh-pf-order-right">
                        <span class="qh-pf-status {{ order.status }}">
                            {% if order.status == 'awaiting_payment' %}Chờ thanh toán
                            {% elif order.status == 'pending' %}Chờ xử lý
                            {% elif order.status == 'processing' %}Đang xử lý
                            {% elif order.status == 'shipped' %}Đang giao
                            {% elif order.status == 'delivered' %}Đã giao
                            {% elif order.status == 'cancelled' %}Đã hủy
                            {% endif %}
                        </span>
                        <div class="qh-pf-order-amount">{{ order.total_amount|format_price_with_unit }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="qh-pf-empty">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <h3>Chưa có đơn hàng nào</h3>
                    <p>Hãy mua sắm để xem lịch sử đơn hàng tại đây!</p>
                    <a href="{% url 'store:home' %}" class="qh-btn qh-btn-primary">Tiếp tục mua sắm</a>
                </div>
            {% endif %}
        </div>

        <!-- Student - Teacher -->
        <div class="qh-pf-tab-panel" id="tab-student">
            <div class="qh-pf-empty">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 14l9-5-9-5-9 5 9 5z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                </svg>
                <h3>Chương trình Student - Teacher</h3>
                <p>Xác minh bạn là học sinh/sinh viên hoặc giáo viên để nhận ưu đãi đặc biệt!</p>
                <button class="qh-btn qh-btn-primary">Xác minh ngay</button>
            </div>
        </div>

        <!-- Đổi mật khẩu -->
        <div class="qh-pf-tab-panel" id="tab-password">
            <div class="qh-pf-pw-grid">
                <!-- Left: Change password form -->
                <div class="qh-pf-pw-section">
                    <div class="qh-pf-pw-title">
                        <i class="ri-lock-password-line"></i> Đổi mật khẩu
                    </div>
                    <form class="qh-pf-form" method="POST" id="changePasswordForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_password">
                        <div class="qh-form-group">
                            <label class="qh-label">Mật khẩu hiện tại</label>
                            <input type="password" name="current_password" class="qh-input" placeholder="Nhập mật khẩu hiện tại" required>
                        </div>
                        <div class="qh-form-group">
                            <label class="qh-label">Mật khẩu mới</label>
                            <input type="password" name="new_password" class="qh-input" placeholder="Nhập mật khẩu mới" required>
                        </div>
                        <div class="qh-form-group">
                            <label class="qh-label">Xác nhận mật khẩu mới</label>
                            <input type="password" name="confirm_password" class="qh-input" placeholder="Nhập lại mật khẩu mới" required>
                        </div>
                        <button type="submit" class="qh-btn qh-btn-primary" style="width: 100%; font-size: 16px; font-weight: 600;">
                            Cập nhật mật khẩu
                        </button>
                    </form>
                </div>

                <!-- Right: Password change history -->
                <div class="qh-pf-pw-section">
                    <div class="qh-pf-pw-title">
                        <i class="ri-history-line"></i> Lịch sử đổi mật khẩu
                    </div>
                    {% if password_history %}
                    <div class="qh-pf-pw-history" id="pwHistoryList">
                        {% for record in password_history %}
                        <div class="qh-pf-pw-item" data-pw-index="{{ forloop.counter }}">
                            <div class="qh-pf-pw-item-icon">
                                <i class="ri-check-line"></i>
                            </div>
                            <div class="qh-pf-pw-item-info">
                                <div class="qh-pf-pw-item-date">{{ record.changed_at|date:"d/m/Y - H:i" }}</div>
                                <div class="qh-pf-pw-item-detail">
                                    IP: {{ record.ip_address|default:"Không xác định" }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="qh-pf-pw-pagination" id="pwPagination"></div>
                    {% else %}
                    <div style="text-align: center; padding: 40px 0; color: var(--qh-text-light);">
                        <i class="ri-history-line" style="font-size: 48px; display: block; margin-bottom: 12px; color: #d1d5db;"></i>
                        <p style="font-size: 14px;">Chưa có lịch sử đổi mật khẩu</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Hoàn tiền -->
        <div class="qh-pf-tab-panel" id="tab-refund">
            <!-- Box bọc chia đôi -->
            <div class="qh-pf-refund-split" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Danh sách đơn cần hoàn tiền -->
                <div class="qh-pf-refund-list" style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px;">
                    <h3 style="font-size:16px;font-weight:700;color:var(--qh-text);margin-bottom:16px;">Đơn cần hoàn tiền</h3>
                    <div id="qh-refund-pending-list" style="max-height: 300px; overflow-y: auto;">
                        <p style="color:#94a3b8;font-size:14px;text-align:center;padding:20px;">Đang tải...</p>
                    </div>
                </div>
                
                <!-- Lịch sử hoàn tiền -->
                <div class="qh-pf-refund-history" style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px;">
                    <h3 style="font-size:16px;font-weight:700;color:var(--qh-text);margin-bottom:16px;">Lịch sử hoàn tiền</h3>
                    <div id="qh-refund-history-list" style="max-height: 300px; overflow-y: auto;">
                        <p style="color:#94a3b8;font-size:14px;text-align:center;padding:20px;">Đang tải...</p>
                    </div>
                </div>
            </div>
            
            <!-- Chi tiết hoàn tiền Modal -->
            <div class="qh-modal-overlay" id="qhRefundDetailModal" onclick="qhCloseRefundDetailOnClickOutside(event)">
                <div class="qh-modal" onclick="event.stopPropagation()" style="max-width: 700px;">
                    <div class="qh-modal-header">
                        <h3>Chi tiết hoàn tiền</h3>
                        <button class="qh-modal-close" onclick="qhCloseRefundDetail()">&times;</button>
                    </div>
                    <div class="qh-modal-body" id="qhRefundDetailBody">
                        <p style="text-align:center;color:#94a3b8;">Đang tải...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tab Switching Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.qh-pf-tab[data-tab]');
    const panels = document.querySelectorAll('.qh-pf-tab-panel');

    function activateTab(tabName) {
        tabs.forEach(function(t) { t.classList.remove('active'); });
        panels.forEach(function(p) { p.classList.remove('active'); });
        var targetTab = document.querySelector('.qh-pf-tab[data-tab="' + tabName + '"]');
        var targetPanel = document.getElementById('tab-' + tabName);
        if (targetTab) targetTab.classList.add('active');
        if (targetPanel) targetPanel.classList.add('active');
    }

    // Check URL param ?tab=xxx
    var urlParams = new URLSearchParams(window.location.search);
    var tabParam = urlParams.get('tab');
    if (tabParam) {
        activateTab(tabParam);
    }

    tabs.forEach(function(tab) {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.getAttribute('data-tab');
            activateTab(target);
        });
    });

    // ---- Password History Pagination ----
    var PW_PER_PAGE = 4;
    var pwItems = document.querySelectorAll('.qh-pf-pw-item[data-pw-index]');
    var pwPagination = document.getElementById('pwPagination');

    if (pwItems.length > 0 && pwPagination) {
        var totalPages = Math.ceil(pwItems.length / PW_PER_PAGE);

        function showPwPage(page) {
            var start = (page - 1) * PW_PER_PAGE;
            var end = start + PW_PER_PAGE;
            pwItems.forEach(function(item, i) {
                item.style.display = (i >= start && i < end) ? '' : 'none';
            });
            renderPwPagination(page);
        }

        function renderPwPagination(current) {
            if (totalPages <= 1) { pwPagination.style.display = 'none'; return; }
            var html = '';
            html += '<button class="qh-pf-pw-page-btn" data-pw-page="' + (current - 1) + '"' + (current === 1 ? ' disabled' : '') + '><i class="ri-arrow-left-s-line"></i></button>';
            for (var p = 1; p <= totalPages; p++) {
                html += '<button class="qh-pf-pw-page-btn' + (p === current ? ' active' : '') + '" data-pw-page="' + p + '">' + p + '</button>';
            }
            html += '<button class="qh-pf-pw-page-btn" data-pw-page="' + (current + 1) + '"' + (current === totalPages ? ' disabled' : '') + '><i class="ri-arrow-right-s-line"></i></button>';
            pwPagination.innerHTML = html;

            pwPagination.querySelectorAll('.qh-pf-pw-page-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    showPwPage(parseInt(this.getAttribute('data-pw-page')));
                });
            });
        }

        showPwPage(1);
    }

    // ---- Address Pagination ----
    var ADDR_PER_PAGE = 3;
    var addrItems = document.querySelectorAll('.qh-pf-addr-card[data-addr-index]');
    var addrPagination = document.getElementById('addrPagination');

    if (addrItems.length > 0 && addrPagination) {
        var addrTotalPages = Math.ceil(addrItems.length / ADDR_PER_PAGE);

        function showAddrPage(page) {
            var start = (page - 1) * ADDR_PER_PAGE;
            var end = start + ADDR_PER_PAGE;
            addrItems.forEach(function(item, i) {
                item.style.display = (i >= start && i < end) ? '' : 'none';
            });
            renderAddrPagination(page);
        }

        function renderAddrPagination(current) {
            if (addrTotalPages <= 1) { addrPagination.style.display = 'none'; return; }
            var html = '';
            html += '<button class="qh-pf-pw-page-btn" data-addr-page="' + (current - 1) + '"' + (current === 1 ? ' disabled' : '') + '><i class="ri-arrow-left-s-line"></i></button>';
            for (var p = 1; p <= addrTotalPages; p++) {
                html += '<button class="qh-pf-pw-page-btn' + (p === current ? ' active' : '') + '" data-addr-page="' + p + '">' + p + '</button>';
            }
            html += '<button class="qh-pf-pw-page-btn" data-addr-page="' + (current + 1) + '"' + (current === addrTotalPages ? ' disabled' : '') + '><i class="ri-arrow-right-s-line"></i></button>';
            addrPagination.innerHTML = html;

            addrPagination.querySelectorAll('.qh-pf-pw-page-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    showAddrPage(parseInt(this.getAttribute('data-addr-page')));
                });
            });
        }

        showAddrPage(1);
    }

    // ---- Load Provinces ----
    loadProvinces();
});

/* ==================== CSRF Token ==================== */
function getAddrCsrf() {
    var name = 'csrftoken';
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

/* ==================== Provinces API ==================== */
var provincesData = [];
var districtsData = [];
var wardsData = [];

function loadProvinces() {
    fetch('https://provinces.open-api.vn/api/p/')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            provincesData = data;
            var sel = document.getElementById('addrProvince');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Chọn Tỉnh/Thành phố --</option>';
            data.forEach(function(p) {
                sel.innerHTML += '<option value="' + p.code + '">' + p.name + '</option>';
            });
        })
        .catch(function(err) { console.error('Load provinces error:', err); });
}

function loadDistricts() {
    var sel = document.getElementById('addrProvince');
    var distSel = document.getElementById('addrDistrict');
    var wardSel = document.getElementById('addrWard');
    distSel.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
    distSel.disabled = true;
    wardSel.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
    wardSel.disabled = true;

    if (!sel.value) return;

    fetch('https://provinces.open-api.vn/api/p/' + sel.value + '?depth=2')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            districtsData = data.districts || [];
            distSel.disabled = false;
            districtsData.forEach(function(d) {
                distSel.innerHTML += '<option value="' + d.code + '">' + d.name + '</option>';
            });
        })
        .catch(function(err) { console.error('Load districts error:', err); });
}

function loadWards() {
    var distSel = document.getElementById('addrDistrict');
    var wardSel = document.getElementById('addrWard');
    wardSel.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
    wardSel.disabled = true;

    if (!distSel.value) return;

    fetch('https://provinces.open-api.vn/api/d/' + distSel.value + '?depth=2')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            wardsData = data.wards || [];
            wardSel.disabled = false;
            wardsData.forEach(function(w) {
                wardSel.innerHTML += '<option value="' + w.code + '">' + w.name + '</option>';
            });
        })
        .catch(function(err) { console.error('Load wards error:', err); });
}

/* ==================== Add Address ==================== */
function submitAddress(e) {
    e.preventDefault();
    var form = document.getElementById('addAddressForm');
    var btn = document.getElementById('addrSubmitBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="ri-loader-4-line" style="margin-right:4px;"></i> Đang thêm...';

    var provinceSel = document.getElementById('addrProvince');
    var districtSel = document.getElementById('addrDistrict');
    var wardSel = document.getElementById('addrWard');

    var body = 'full_name=' + encodeURIComponent(form.full_name.value)
        + '&phone=' + encodeURIComponent(form.phone.value)
        + '&province_code=' + provinceSel.value
        + '&province_name=' + encodeURIComponent(provinceSel.options[provinceSel.selectedIndex].text)
        + '&district_code=' + districtSel.value
        + '&district_name=' + encodeURIComponent(districtSel.options[districtSel.selectedIndex].text)
        + '&ward_code=' + wardSel.value
        + '&ward_name=' + encodeURIComponent(wardSel.options[wardSel.selectedIndex].text)
        + '&detail=' + encodeURIComponent(form.detail.value)
        + '&is_default=' + (document.getElementById('addrDefault').checked ? 'true' : 'false');

    fetch('/address/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getAddrCsrf()
        },
        body: body
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            if (window.QHToast) QHToast.show(data.message, 'success');
            setTimeout(function() { location.reload(); }, 600);
        } else {
            if (window.QHToast) QHToast.show(data.message, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-add-line" style="margin-right:4px;"></i> Thêm địa chỉ';
        }
    })
    .catch(function(err) {
        console.error('Error:', err);
        if (window.QHToast) QHToast.show('Có lỗi xảy ra', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="ri-add-line" style="margin-right:4px;"></i> Thêm địa chỉ';
    });

    return false;
}

/* ==================== Delete Address ==================== */
function deleteAddress(id) {
    if (window.QHConfirm) {
        QHConfirm.show('Bạn có chắc muốn xóa địa chỉ này?', function() {
            doDeleteAddress(id);
        });
    } else {
        doDeleteAddress(id);
    }
}
function doDeleteAddress(id) {
    fetch('/address/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getAddrCsrf()
        },
        body: 'address_id=' + id
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            if (window.QHToast) QHToast.show(data.message, 'success');
            setTimeout(function() { location.reload(); }, 600);
        } else {
            if (window.QHToast) QHToast.show(data.message, 'error');
        }
    })
    .catch(function(err) {
        console.error('Error:', err);
        if (window.QHToast) QHToast.show('Có lỗi xảy ra', 'error');
    });
}

/* ==================== Set Default Address ==================== */
function setDefaultAddress(id) {
    fetch('/address/set-default/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getAddrCsrf()
        },
        body: 'address_id=' + id
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            if (window.QHToast) QHToast.show(data.message, 'success');
            setTimeout(function() { location.reload(); }, 600);
        } else {
            if (window.QHToast) QHToast.show(data.message, 'error');
        }
    })
    .catch(function(err) {
        console.error('Error:', err);
        if (window.QHToast) QHToast.show('Có lỗi xảy ra', 'error');
    });
}

/* ==================== Refund Functions ==================== */
function qhGetCookie(name) {
    var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
}

function qhLoadRefundData() {
    // Load đơn cần hoàn tiền (cancelled + vietqr/vnpay)
    fetch('/api/refund-pending/', {
        method: 'GET',
        headers: { 'X-CSRFToken': qhGetCookie('csrftoken') }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        var listEl = document.getElementById('qh-refund-pending-list');
        if (data.orders && data.orders.length > 0) {
            var html = '<table class="qh-refund-table" style="width:100%;font-size:13px;border-collapse:collapse;">';
            html += '<thead><tr style="background:#f8fafc;border-bottom:1px solid #e2e8f0;">';
            html += '<th style="padding:8px;text-align:left;font-weight:600;color:#64748b;">Mã đơn</th>';
            html += '<th style="padding:8px;text-align:left;font-weight:600;color:#64748b;">Sản phẩm</th>';
            html += '<th style="padding:8px;text-align:center;font-weight:600;color:#64748b;">Trạng thái</th>';
            html += '<th style="padding:8px;text-align:center;font-weight:600;color:#64748b;">Xem</th>';
            html += '</tr></thead><tbody>';
            data.orders.forEach(function(o) {
                html += '<tr style="border-bottom:1px solid #f1f5f9;">';
                html += '<td style="padding:8px;color:#3b82f6;font-weight:600;">' + o.order_code + '</td>';
                html += '<td style="padding:8px;color:#1e293b;">' + (o.items.length > 0 ? o.items[0].product_name : '—') + '</td>';
                html += '<td style="padding:8px;text-align:center;"><span class="qh-ot-badge cancelled">Chờ hoàn tiền</span></td>';
                html += '<td style="padding:8px;text-align:center;"><button onclick="qhShowRefundDetail(\'' + o.order_code + '\')" style="padding:4px 12px;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Xem</button></td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            listEl.innerHTML = html;
        } else {
            listEl.innerHTML = '<p style="color:#94a3b8;font-size:14px;text-align:center;padding:20px;">Không có đơn cần hoàn tiền</p>';
        }
    })
    .catch(function(err) {
        document.getElementById('qh-refund-pending-list').innerHTML = '<p style="color:#ef4444;font-size:14px;text-align:center;padding:20px;">Lỗi tải dữ liệu</p>';
    });
    
    // Load lịch sử hoàn tiền (đã hoàn tiền)
    fetch('/api/refund-history/', {
        method: 'GET',
        headers: { 'X-CSRFToken': qhGetCookie('csrftoken') }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        var listEl = document.getElementById('qh-refund-history-list');
        if (data.orders && data.orders.length > 0) {
            var html = '';
            data.orders.forEach(function(o) {
                var productName = o.items.length > 0 ? o.items[0].product_name : '—';
                html += '<div style="padding:12px;background:#f8fafc;border-radius:8px;margin-bottom:8px;cursor:pointer;" onclick="qhShowRefundDetail(\'' + o.order_code + '\')">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                html += '<span style="color:#3b82f6;font-weight:600;font-size:13px;">' + o.order_code + '</span>';
                html += '<span style="color:#10b981;font-weight:600;font-size:14px;">Đã hoàn ' + qhFmtVND(o.total_amount) + '</span>';
                html += '</div>';
                html += '<div style="color:#64748b;font-size:12px;margin-top:4px;">' + productName + '</div>';
                html += '</div>';
            });
            listEl.innerHTML = html;
        } else {
            listEl.innerHTML = '<p style="color:#94a3b8;font-size:14px;text-align:center;padding:20px;">Chưa có lịch sử hoàn tiền</p>';
        }
    })
    .catch(function(err) {
        document.getElementById('qh-refund-history-list').innerHTML = '<p style="color:#ef4444;font-size:14px;text-align:center;padding:20px;">Lỗi tải dữ liệu</p>';
    });
}

function qhShowRefundDetail(orderCode) {
    fetch('/api/refund-detail/' + orderCode + '/', {
        method: 'GET',
        headers: { 'X-CSRFToken': qhGetCookie('csrftoken') }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        var modal = document.getElementById('qhRefundDetailModal');
        var body = document.getElementById('qhRefundDetailBody');
        modal.classList.add('active');
        
        if (!data.order) {
            body.innerHTML = '<p style="color:#ef4444;text-align:center;">Không tìm thấy đơn hàng</p>';
            return;
        }
        
        var o = data.order;
        var html = '<table style="width:100%;font-size:13px;border-collapse:collapse;margin-bottom:16px;">';
        html += '<thead><tr style="background:#f8fafc;">';
        html += '<th style="padding:8px;text-align:left;font-weight:600;color:#64748b;">Mã đơn</th>';
        html += '<th style="padding:8px;text-align:left;font-weight:600;color:#64748b;">Sản phẩm</th>';
        html += '<th style="padding:8px;text-align:center;font-weight:600;color:#64748b;">SL</th>';
        html += '<th style="padding:8px;text-align:center;font-weight:600;color:#64748b;">Màu</th>';
        html += '<th style="padding:8px;text-align:center;font-weight:600;color:#64748b;">Bộ nhớ</th>';
        html += '<th style="padding:8px;text-align:right;font-weight:600;color:#64748b;">Giá</th>';
        html += '<th style="padding:8px;text-align:center;font-weight:600;color:#64748b;">STK</th>';
        html += '<th style="padding:8px;text-align:center;font-weight:600;color:#64748b;">Ngân hàng</th>';
        html += '</tr></thead><tbody>';
        
        o.items.forEach(function(item) {
            html += '<tr style="border-bottom:1px solid #f1f5f9;">';
            html += '<td style="padding:8px;color:#3b82f6;font-weight:600;">' + o.order_code + '</td>';
            html += '<td style="padding:8px;color:#1e293b;">' + item.product_name + '</td>';
            html += '<td style="padding:8px;text-align:center;color:#64748b;">' + item.quantity + '</td>';
            html += '<td style="padding:8px;text-align:center;color:#64748b;">' + (item.color_name || '—') + '</td>';
            html += '<td style="padding:8px;text-align:center;color:#64748b;">' + (item.storage || '—') + '</td>';
            html += '<td style="padding:8px;text-align:right;color:#1e293b;font-weight:600;">' + qhFmtVND(item.price) + '</td>';
            html += '<td style="padding:8px;text-align:center;color:#64748b;">' + (o.refund_account || '—') + '</td>';
            html += '<td style="padding:8px;text-align:center;color:#64748b;">' + (o.refund_bank || '—') + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table>';
        
        html += '<div style="background:#f8fafc;padding:12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;">';
        html += '<span style="font-weight:600;color:#334155;">Tổng hoàn tiền:</span>';
        html += '<span style="font-size:18px;font-weight:700;color:#ef4444;">' + qhFmtVND(o.total_amount) + '</span>';
        html += '</div>';
        
        body.innerHTML = html;
    })
    .catch(function(err) {
        document.getElementById('qhRefundDetailBody').innerHTML = '<p style="color:#ef4444;text-align:center;">Lỗi tải dữ liệu</p>';
    });
}

function qhCloseRefundDetail() {
    document.getElementById('qhRefundDetailModal').classList.remove('active');
}

function qhCloseRefundDetailOnClickOutside(event) {
    if (event.target.classList.contains('qh-modal-overlay')) {
        qhCloseRefundDetail();
    }
}

function qhFmtVND(v) {
    var n = parseInt(v, 10);
    if (isNaN(n)) return '0đ';
    return n.toLocaleString('vi-VN') + 'đ';
}

// Load refund data when tab is activated
document.addEventListener('DOMContentLoaded', function() {
    // Override activateTab to load refund data when refund tab is opened
    var originalActivateTab;
    var tabs = document.querySelectorAll('.qh-pf-tab[data-tab]');
    tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
            var target = this.getAttribute('data-tab');
            if (target === 'refund') {
                setTimeout(qhLoadRefundData, 100);
            }
        });
    });
});
</script>
{% endblock %}
