{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}T√ÄI KHO·∫¢N - QHUN22 Mobile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="qh-profile-page">

    <!-- ====== TH·∫∫ TH√îNG TIN NG∆Ø·ªúI D√ôNG ====== -->
    <div class="qh-pf-info-card">
        <!-- Avatar + Th√¥ng tin -->
        <div class="qh-pf-user">
            <div class="qh-pf-avatar">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
            </div>
            <div>
                <div class="qh-pf-name">
                    {% if user.last_name %}{{ user.last_name }}{% else %}{{ user.email }}{% endif %}
                </div>
                <div class="qh-pf-detail">
                    {% if user.phone %}{{ user.phone }}<br>{% endif %}
                    {{ user.email }}
                </div>
            </div>
        </div>

        <!-- Th·ªëng k√™ -->
        <div class="qh-pf-stats">
            <div class="qh-pf-stat">
                <div class="qh-pf-stat-icon"><i class="ri-shopping-bag-3-line"></i></div>
                <div class="qh-pf-stat-content">
                    <div class="qh-pf-stat-value">{{ total_orders|default:"0" }}</div>
                    <div class="qh-pf-stat-label">T·ªïng s·ªë ƒë∆°n h√†ng ƒë√£ mua</div>
                </div>
            </div>
            <div class="qh-pf-stat">
                <div class="qh-pf-stat-icon"><i class="ri-money-dollar-circle-line"></i></div>
                <div class="qh-pf-stat-content">
                    <div class="qh-pf-stat-value">{{ total_spent|default:"0" }}ƒë</div>
                    <div class="qh-pf-stat-label">T·ªïng s·ªë ti·ªÅn ƒë√£ ti√™u d√πng</div>
                </div>
            </div>
            <div class="qh-pf-stat">
                {% if total_spent_raw >= 500000000 %}
                <div class="qh-pf-rank-icon diamond"><i class="ri-vip-diamond-fill"></i></div>
                <div class="qh-pf-stat-content"><div class="qh-pf-rank-label diamond">H·∫°ng: Kim c∆∞∆°ng</div></div>
                {% elif total_spent_raw >= 200000000 %}
                <div class="qh-pf-rank-icon gold"><i class="ri-medal-fill"></i></div>
                <div class="qh-pf-stat-content"><div class="qh-pf-rank-label gold">H·∫°ng: V√†ng</div></div>
                {% elif total_spent_raw >= 50000000 %}
                <div class="qh-pf-rank-icon silver"><i class="ri-shield-star-fill"></i></div>
                <div class="qh-pf-stat-content"><div class="qh-pf-rank-label silver">H·∫°ng: B·∫°c</div></div>
                {% else %}
                <div class="qh-pf-rank-icon bronze"><i class="ri-copper-coin-fill"></i></div>
                <div class="qh-pf-stat-content"><div class="qh-pf-rank-label bronze">H·∫°ng: ƒê·ªìng</div></div>
                {% endif %}
            </div>
        </div>

        <!-- ƒêƒÉng xu·∫•t -->
        <div class="qh-pf-logout-section">
            <a href="{% url 'account_logout' %}" class="qh-pf-logout-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                ƒêƒÉng xu·∫•t
            </a>
        </div>
    </div>

    <!-- ====== ƒêI·ªÄU H∆Ø·ªöNG TAB ====== -->
    <div class="qh-pf-tabs">
        <!-- Trang qu·∫£n tr·ªã -->
        {% if user.is_superuser %}
        <a href="{% url 'store:dashboard' %}" class="qh-pf-tab">
            <i class="ri-dashboard-line"></i>
            Dashboard
        </a>
        {% endif %}

        <a href="#" class="qh-pf-tab active" data-tab="address">
            <i class="ri-map-pin-line"></i>
            S·ªï ƒë·ªãa ch·ªâ
        </a>
        <a href="#" class="qh-pf-tab" data-tab="password">
            <i class="ri-lock-password-line"></i>
            ƒê·ªïi m·∫≠t kh·∫©u
        </a>
        <a href="#" class="qh-pf-tab" data-tab="student">
            <i class="ri-map-pin-user-line"></i>
            Student - Teacher
        </a>
        <a href="#" class="qh-pf-tab" data-tab="coupon">
            <i class="ri-coupon-3-line"></i>
            M√£ gi·∫£m gi√°
        </a>
        <a href="#" class="qh-pf-tab" data-tab="history">
            <i class="ri-file-list-3-line"></i>
            L·ªãch s·ª≠ mua h√†ng
        </a>
        <a href="#" class="qh-pf-tab" data-tab="refund">
            <i class="ri-refund-2-line"></i>
            Ho√†n ti·ªÅn
        </a>
    </div>

    <!-- ====== N·ªòI DUNG TAB ====== -->
    <div class="qh-pf-content">

        <!-- S·ªï ƒë·ªãa ch·ªâ -->
        <div class="qh-pf-tab-panel active" id="tab-address">
            <div class="qh-pf-addr-grid">
                <!-- Tr√°i: Th√™m ƒë·ªãa ch·ªâ m·ªõi -->
                <div class="qh-pf-addr-section">
                    <div class="qh-pf-addr-title">
                        <i class="ri-add-circle-line"></i> Th√™m ƒë·ªãa ch·ªâ m·ªõi
                    </div>
                    <form class="qh-pf-addr-form" id="addAddressForm" onsubmit="return submitAddress(event)">
                        {% csrf_token %}
                        <div class="qh-form-group qh-form-row">
                            <div>
                                <label class="qh-label">H·ªç t√™n</label>
                                <input type="text" name="full_name" class="qh-input" placeholder="Nh·∫≠p h·ªç t√™n" required>
                            </div>
                            <div>
                                <label class="qh-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="text" name="phone" class="qh-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                            </div>
                        </div>
                        <div class="qh-form-group">
                            <label class="qh-label">T·ªânh/Th√†nh ph·ªë</label>
                            <select name="province" class="qh-input" id="addrProvince" onchange="loadDistricts()" required>
                                <option value="">-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>
                            </select>
                        </div>
                        <div class="qh-form-group qh-form-row">
                            <div>
                                <label class="qh-label">Qu·∫≠n/Huy·ªán</label>
                                <select name="district" class="qh-input" id="addrDistrict" onchange="loadWards()" required disabled>
                                    <option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>
                                </select>
                            </div>
                            <div>
                                <label class="qh-label">Ph∆∞·ªùng/X√£</label>
                                <select name="ward" class="qh-input" id="addrWard" required disabled>
                                    <option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>
                                </select>
                            </div>
                        </div>
                        <div class="qh-form-group">
                            <label class="qh-label">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                            <input type="text" name="detail" class="qh-input" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, t√≤a nh√†..." required>
                        </div>
                        <div class="qh-addr-checkbox-row">
                            <input type="checkbox" id="addrDefault" name="is_default">
                            <label for="addrDefault">ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh</label>
                        </div>
                        <button type="submit" class="qh-btn qh-btn-primary" id="addrSubmitBtn" style="width: 100%; font-size: 15px; font-weight: 600;">
                            <i class="ri-add-line" style="margin-right: 4px;"></i> Th√™m ƒë·ªãa ch·ªâ
                        </button>
                    </form>
                </div>

                <!-- Ph·∫£i: Danh s√°ch ƒë·ªãa ch·ªâ -->
                <div class="qh-pf-addr-section">
                    <div class="qh-pf-addr-title">
                        <i class="ri-map-pin-line"></i> Danh s√°ch ƒë·ªãa ch·ªâ c·ªßa b·∫°n
                    </div>
                    <div class="qh-pf-addr-list" id="addressList">
                        {% if addresses %}
                            {% for addr in addresses %}
                            <div class="qh-pf-addr-card{% if addr.is_default %} is-default{% endif %}" id="addrCard_{{ addr.id }}" data-addr-index="{{ forloop.counter }}">
                                <div class="qh-pf-addr-card-header">
                                    <div>
                                        <span class="qh-pf-addr-name">{{ addr.full_name }}</span>
                                        <span class="qh-pf-addr-phone">{{ addr.phone }}</span>
                                    </div>
                                    {% if addr.is_default %}
                                    <span class="qh-pf-addr-default-badge"><i class="ri-check-line"></i> M·∫∑c ƒë·ªãnh</span>
                                    {% endif %}
                                </div>
                                <div class="qh-pf-addr-detail">
                                    {{ addr.detail }}, {{ addr.ward_name }}, {{ addr.district_name }}, {{ addr.province_name }}
                                </div>
                                <div class="qh-pf-addr-actions">
                                    {% if not addr.is_default %}
                                    <button class="qh-addr-set-default" onclick="setDefaultAddress({{ addr.id }})">
                                        <i class="ri-check-double-line"></i> ƒê·∫∑t m·∫∑c ƒë·ªãnh
                                    </button>
                                    {% endif %}
                                    <button class="qh-addr-del" onclick="deleteAddress({{ addr.id }})">
                                        <i class="ri-delete-bin-line"></i> X√≥a
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="qh-pf-empty" id="addrEmptyState">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:60px;height:60px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <h3 style="font-size:16px;">Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o</h3>
                                <p style="font-size:13px;">Th√™m ƒë·ªãa ch·ªâ giao h√†ng ·ªü b√™n tr√°i nh√©!</p>
                            </div>
                        {% endif %}
                    </div>
                    <div class="qh-pf-pw-pagination" id="addrPagination"></div>
                </div>
            </div>
        </div>

        <!-- M√£ gi·∫£m gi√° -->
        <div class="qh-pf-tab-panel" id="tab-coupon">
            <div id="couponGridContainer">
            {% if available_coupons %}
            <div class="qh-pf-coupon-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                {% for cp in available_coupons %}
                <div class="qh-pf-coupon-card" data-coupon-index="{{ forloop.counter }}" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden; display: flex; border: 1px solid #e2e8f0;">
                    <!-- Vi·ªÅn tr√°i -->
                    <div style="width: 90px; background: linear-gradient(135deg, {% if cp.discount_type == 'percentage' %}#3b82f6, #2563eb{% else %}#10b981, #059669{% endif %}); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; flex-shrink: 0; position: relative;">
                        <div style="font-size: 28px; font-weight: 800; line-height: 1;">{% if cp.discount_type == 'percentage' %}{{ cp.discount_value|floatformat:0 }}%{% else %}{{ cp.discount_value|floatformat:0 }}ƒë{% endif %}</div>
                        <div style="font-size: 11px; font-weight: 500; opacity: 0.85; margin-top: 2px;">GI·∫¢M</div>
                        <!-- C·∫°nh rƒÉng c∆∞a -->
                        <div style="position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: white; border-radius: 50%;"></div>
                    </div>
                    <!-- N·ªôi dung b√™n ph·∫£i -->
                    <div style="flex: 1; padding: 14px 16px; display: flex; flex-direction: column; justify-content: center; min-width: 0;">
                        <div style="font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ cp.name }}</div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="background: #f1f5f9; padding: 3px 10px; border-radius: 6px; font-size: 13px; font-weight: 700; color: #334155; letter-spacing: 1px; font-family: 'Signika', monospace;">{{ cp.code }}</span>
                            <button type="button" onclick="copyVoucher(this, '{{ cp.code }}')" style="background: none; border: 1px solid #cbd5e1; border-radius: 6px; padding: 3px 8px; cursor: pointer; font-size: 12px; color: #64748b; font-family: 'Signika', sans-serif; display: flex; align-items: center; gap: 4px;">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Sao ch√©p
                            </button>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; font-size: 12px; color: #64748b;">
                            {% if cp.min_order_amount > 0 %}<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px;">ƒê∆°n t·ªëi thi·ªÉu {{ cp.min_order_amount|floatformat:0 }}ƒë</span>{% endif %}
                            {% if cp.max_products > 0 %}<span style="background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 4px;">T·ªëi ƒëa {{ cp.max_products }} SP</span>{% endif %}
                            <span style="background: #f1f5f9; color: #64748b; padding: 2px 8px; border-radius: 4px;">HSD: {{ cp.expire_at|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="qh-pf-coupon-pagination" id="couponPagination" style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--qh-border);"></div>
            {% else %}
            <div class="qh-pf-empty">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                </svg>
                <h3>Ch∆∞a c√≥ m√£ gi·∫£m gi√°</h3>
                <p>H√£y theo d√µi ƒë·ªÉ nh·∫≠n m√£ gi·∫£m gi√° h·∫•p d·∫´n nh√©!</p>
            </div>
            {% endif %}
            </div>
        </div>

        <!-- L·ªãch s·ª≠ mua h√†ng -->
        <div class="qh-pf-tab-panel" id="tab-history">
            {% if orders %}
            <div class="qh-pf-order-grid">
                {% for order in orders %}
                <div class="qh-pf-order-card" data-order-index="{{ forloop.counter }}">
                    <div class="qh-pf-order-id">ƒê∆°n h√†ng <span>#{{ order.order_code }}</span></div>
                    <div class="qh-pf-order-date">{{ order.created_at|date:"d/m/Y H:i" }}</div>
                    {% with first_item=order.items.first %}
                    {% if first_item %}
                    <div class="qh-pf-order-product">{{ first_item.product_name }}{% if order.items.count > 1 %} <span class="qh-pf-order-more">+{{ order.items.count|add:"-1" }} s·∫£n ph·∫©m kh√°c</span>{% endif %}</div>
                    {% endif %}
                    {% endwith %}
                    <div class="qh-pf-order-right">
                        <span class="qh-pf-status {{ order.status }}">
                            {% if order.status == 'awaiting_payment' %}Ch·ªù thanh to√°n
                            {% elif order.status == 'pending' %}Ch·ªù x·ª≠ l√Ω
                            {% elif order.status == 'processing' %}ƒêang x·ª≠ l√Ω
                            {% elif order.status == 'shipped' %}ƒêang giao
                            {% elif order.status == 'delivered' %}ƒê√£ giao
                            {% elif order.status == 'cancelled' %}ƒê√£ h·ªßy
                            {% endif %}
                        </span>
                        <div class="qh-pf-order-amount">{{ order.total_amount|format_price_with_unit }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="qh-pf-order-pagination" id="orderPagination"></div>
            {% else %}
                <div class="qh-pf-empty">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <h3>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
                    <p>H√£y mua s·∫Øm ƒë·ªÉ xem l·ªãch s·ª≠ ƒë∆°n h√†ng t·∫°i ƒë√¢y!</p>
                    <a href="{% url 'store:home' %}" class="qh-btn qh-btn-primary">Ti·∫øp t·ª•c mua s·∫Øm</a>
                </div>
            {% endif %}
        </div>

        <!-- H·ªçc sinh - Gi√°o vi√™n -->
        <div class="qh-pf-tab-panel" id="tab-student">
            <!-- Layout chia 2 c·ªôt: Tr√°i = Th√¥ng tin x√°c th·ª±c, Ph·∫£i = L·ªãch s·ª≠ -->
            <div class="qh-pf-pw-grid">
                <!-- C·ªôt tr√°i: Th√¥ng tin x√°c th·ª±c -->
                <div class="qh-pf-pw-section">
                    <div class="qh-pf-pw-title">
                        <i class="ri-shield-check-line"></i> X√°c th·ª±c t√†i kho·∫£n Edu
                    </div>
                    
                    {% if user.is_student_verified or user.is_teacher_verified %}
                    {# ƒê√£ x√°c th·ª±c - hi·ªÉn th·ªã th√¥ng tin #}
                    <div class="qh-pf-student-verified" style="display: none;">
                        <div class="qh-pf-student-verified-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        </div>
                        <span class="qh-pf-student-verified-title">B·∫°n ƒë√£ x√°c th·ª±c th√†nh c√¥ng!</span>
                    </div>
                    
                    <div class="qh-pf-form">
                        
                        <div class="qh-form-group">
                            <label class="qh-label">Tr·∫°ng th√°i</label>
                            <div class="qh-pf-student-status-badge">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span>B·∫°n ƒë√£ x√°c th·ª±c t√†i kho·∫£n</span>
                            </div>
                        </div>

                        <div class="qh-form-group">
                            <label class="qh-label">T√†i kho·∫£n Edu</label>
                            <input type="text" class="qh-input" value="{{ user.verified_student_email|default:'' }}" readonly>
                        </div>
                    </div>
                    
                    {% else %}
                    {# Ch∆∞a x√°c th·ª±c - hi·ªÉn th·ªã form #}
                    <p class="qh-pf-student-desc">S·ª≠ d·ª•ng email <strong>.edu.vn</strong> ƒë·ªÉ x√°c minh v√† nh·∫≠n ∆∞u ƒë√£i ƒë·∫∑c bi·ªát!</p>
                    
                    <div class="qh-pf-form">
                        <div class="qh-form-group">
                            <label class="qh-label">Email .edu.vn</label>
                            <input type="email" id="edu-email" class="qh-input" placeholder="v√≠ d·ª•: sinhvien@ictu.edu.vn" 
                                pattern=".*\.edu\.vn$" title="Vui l√≤ng nh·∫≠p email .edu.vn">
                        </div>
                        
                        <div id="edu-code-section" class="qh-form-group" style="display: none;">
                            <label class="qh-label">M√£ x√°c th·ª±c</label>
                            <input type="text" id="edu-code" class="qh-input" placeholder="Nh·∫≠p m√£ 6 s·ªë" maxlength="6">
                        </div>
                        
                        <p id="edu-message" class="qh-pf-student-message"></p>
                        
                        <button type="button" id="edu-send-btn" onclick="sendEduVerificationCode()" 
                            class="qh-btn qh-btn-primary" style="width: 100%; font-size: 16px; font-weight: 600;">
                            G·ª≠i m√£ x√°c th·ª±c
                        </button>
                        
                        <button type="button" id="edu-verify-btn" onclick="verifyEduCode()" 
                            class="qh-btn qh-btn-primary" style="width: 100%; font-size: 16px; font-weight: 600; display: none;">
                            X√°c th·ª±c ngay
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <!-- C·ªôt ph·∫£i: ∆Øu ƒë√£i -->
                <div class="qh-pf-pw-section">
                    <div class="qh-pf-pw-title">
                        <i class="ri-gift-line"></i> ∆Øu ƒë√£i
                    </div>
                    
                    {% if user.is_student_verified or user.is_teacher_verified %}
                    {# ƒê√£ x√°c th·ª±c - hi·ªÉn th·ªã voucher #}
                    {% if edu_voucher and edu_voucher_status == 'available' %}
                    <div class="qh-pf-student-voucher-code" style="text-align: center; padding: 24px;">
                        <div class="qh-pf-student-voucher-code-title">üéâ ∆Øu ƒë√£i ƒë·∫∑c bi·ªát d√†nh cho b·∫°n!</div>
                        <div class="qh-pf-student-voucher-code-discount">GI·∫¢M 50%</div>
                        <div class="qh-pf-student-voucher-code-limit">Cho 1 ƒë∆°n h√†ng duy nh·∫•t</div>
                        <div class="qh-pf-student-voucher-code-box">
                            <div class="qh-pf-student-voucher-code-label">M√£ voucher c·ªßa b·∫°n:</div>
                            <div class="qh-pf-student-voucher-code-value">{{ edu_voucher.code }}</div>
                        </div>
                        <div class="qh-pf-student-voucher-code-expire">H·∫øt h·∫°n: {{ edu_voucher.expire_at|date:"d/m/Y" }}</div>
                    </div>
                    {% elif edu_voucher_status == 'used' %}
                    <label class="qh-label">Tr·∫°ng th√°i</label>
                    <div class="qh-pf-student-voucher-used">
                        <svg class="qh-pf-student-voucher-used-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="qh-pf-student-voucher-used-text">Voucher ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng</span>
                    </div>
                    {% elif edu_voucher_status == 'expired' %}
                    <div class="qh-pf-student-voucher-expired">
                        <svg class="qh-pf-student-voucher-expired-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="qh-pf-student-voucher-expired-text">Voucher ƒë√£ h·∫øt h·∫°n</span>
                    </div>
                    {% else %}
                    <div class="qh-pf-empty">
                        <i class="ri-gift-line"></i>
                        <h3>Ch∆∞a c√≥ ∆∞u ƒë√£i</h3>
                        <p>X√°c th·ª±c t√†i kho·∫£n Edu ƒë·ªÉ nh·∫≠n voucher gi·∫£m 50%!</p>
                    </div>
                    {% endif %}
                    {% else %}
                    {# Ch∆∞a x√°c th·ª±c #}
                    <div class="qh-pf-empty">
                        <i class="ri-gift-line"></i>
                        <h3>Ch∆∞a c√≥ ∆∞u ƒë√£i</h3>
                        <p>X√°c th·ª±c t√†i kho·∫£n Edu ƒë·ªÉ nh·∫≠n voucher gi·∫£m 50%!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ƒê·ªïi m·∫≠t kh·∫©u -->
        <div class="qh-pf-tab-panel" id="tab-password">
            <div class="qh-pf-pw-grid">
                <!-- Tr√°i: Form ƒë·ªïi m·∫≠t kh·∫©u -->
                <div class="qh-pf-pw-section">
                    <div class="qh-pf-pw-title">
                        <i class="ri-lock-password-line"></i> ƒê·ªïi m·∫≠t kh·∫©u
                    </div>
                    <form class="qh-pf-form" method="POST" id="changePasswordForm">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_password">
                        <div class="qh-form-group">
                            <label class="qh-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                            <input type="password" name="current_password" class="qh-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" required>
                        </div>
                        <div class="qh-form-group">
                            <label class="qh-label">M·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" name="new_password" class="qh-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" required>
                        </div>
                        <div class="qh-form-group">
                            <label class="qh-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" name="confirm_password" class="qh-input" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" required>
                        </div>
                        <button type="submit" class="qh-btn qh-btn-primary" style="width: 100%; font-size: 16px; font-weight: 600;">
                            C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
                        </button>
                    </form>
                </div>

                <!-- Ph·∫£i: L·ªãch s·ª≠ ƒë·ªïi m·∫≠t kh·∫©u -->
                <div class="qh-pf-pw-section">
                    <div class="qh-pf-pw-title">
                        <i class="ri-history-line"></i> L·ªãch s·ª≠ ƒë·ªïi m·∫≠t kh·∫©u
                    </div>
                    {% if password_history %}
                    <div class="qh-pf-pw-history" id="pwHistoryList">
                        {% for record in password_history %}
                        <div class="qh-pf-pw-item" data-pw-index="{{ forloop.counter }}">
                            <div class="qh-pf-pw-item-icon">
                                <i class="ri-check-line"></i>
                            </div>
                            <div class="qh-pf-pw-item-info">
                                <div class="qh-pf-pw-item-date">{{ record.changed_at|date:"d/m/Y - H:i" }}</div>
                                <div class="qh-pf-pw-item-detail">
                                    IP: {{ record.ip_address|default:"Kh√¥ng x√°c ƒë·ªãnh" }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="qh-pf-pw-pagination" id="pwPagination"></div>
                    {% else %}
                    <div style="text-align: center; padding: 40px 0; color: var(--qh-text-light);">
                        <i class="ri-history-line" style="font-size: 48px; display: block; margin-bottom: 12px; color: #d1d5db;"></i>
                        <p style="font-size: 14px;">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒë·ªïi m·∫≠t kh·∫©u</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Ho√†n ti·ªÅn -->
        <div class="qh-pf-tab-panel" id="tab-refund">
            <!-- Box b·ªçc chia ƒë√¥i -->
            <div class="qh-pf-refund-split" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Danh s√°ch ƒë∆°n c·∫ßn ho√†n ti·ªÅn -->
                <div class="qh-pf-refund-list" style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px;">
                    <h3 style="font-size:16px;font-weight:700;color:var(--qh-text);margin-bottom:16px;">ƒê∆°n c·∫ßn ho√†n ti·ªÅn</h3>
                    <div id="qh-refund-pending-list" style="max-height: 300px; overflow-y: auto;">
                        <p style="color:#94a3b8;font-size:14px;text-align:center;padding:20px;">ƒêang t·∫£i...</p>
                    </div>
                </div>
                
                <!-- L·ªãch s·ª≠ ho√†n ti·ªÅn -->
                <div class="qh-pf-refund-history" style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px;">
                    <h3 style="font-size:16px;font-weight:700;color:var(--qh-text);margin-bottom:16px;">L·ªãch s·ª≠ ho√†n ti·ªÅn</h3>
                    <div id="qh-refund-history-list" style="max-height: 300px; overflow-y: auto;">
                        <p style="color:#94a3b8;font-size:14px;text-align:center;padding:20px;">ƒêang t·∫£i...</p>
                    </div>
                </div>
            </div>
            
            <!-- Chi ti·∫øt ho√†n ti·ªÅn Modal -->
            <div class="qh-modal-overlay" id="qhRefundDetailModal" onclick="qhCloseRefundDetailOnClickOutside(event)">
                <div class="qh-modal" onclick="event.stopPropagation()" style="max-width: 700px;">
                    <div class="qh-modal-header">
                        <h3>Chi ti·∫øt ho√†n ti·ªÅn</h3>
                        <button class="qh-modal-close" onclick="qhCloseRefundDetail()">&times;</button>
                    </div>
                    <div class="qh-modal-body" id="qhRefundDetailBody">
                        <p style="text-align:center;color:#94a3b8;">ƒêang t·∫£i...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript chuy·ªÉn tab & to√†n b·ªô trang Profile -->
{# ========================================================================= #}
{# JS THU·∫¶N: ƒê√£ t√°ch ra file static/js/profile.js                     #}
{# JS C√ì DJANGO TAGS: Gi·ªØ nguy√™n trong HTML (xem b√™n d∆∞·ªõi)            #}
{# ========================================================================= #}
<script src="{% static 'js/profile.js' %}"></script>

{# ========================================================================= #}
{# NOTE: JS KH√îNG TH·ªÇ T√ÅCH RA FILE RI√äNG v√¨ s·ª≠ d·ª•ng Django template tags #}
{# - {% url "store:send_verification_code" %} - URL x√°c th·ª±c #}
{# - {% url "store:verify_code" %} - URL x√°c minh #}
{# - {{ csrf_token }} - CSRF token #}
{# N·∫øu t√°ch ra file .js thu·∫ßn, c√°c template tags s·∫Ω kh√¥ng ƒë∆∞·ª£c x·ª≠ l√Ω #}
{# ========================================================================= #}
<script>
/**
 * Bi·∫øn l∆∞u email edu hi·ªán t·∫°i (d√πng chung cho c·∫£ 2 function)
 */
var currentEduEmail = '';

/**
 * G·ª≠i m√£ x√°c th·ª±c ƒë·∫øn email .edu.vn
 * S·ª≠ d·ª•ng Django URL v√† CSRF token
 */
function sendEduVerificationCode() {
    var emailInput = document.getElementById('edu-email');
    var messageEl = document.getElementById('edu-message');
    var email = emailInput.value.trim().toLowerCase();
    
    if (!email) {
        messageEl.innerHTML = '<span style="color: #dc2626;">Vui l√≤ng nh·∫≠p email</span>';
        return;
    }
    
    if (!email.endsWith('.edu.vn')) {
        messageEl.innerHTML = '<span style="color: #dc2626;">Vui l√≤ng s·ª≠ d·ª•ng email .edu.vn (v√≠ d·ª•: sinhvien@ictu.edu.vn)</span>';
        return;
    }
    
    currentEduEmail = email;
    messageEl.innerHTML = '<span style="color: #059669;">ƒêang g·ª≠i m√£ x√°c th·ª±c...</span>';
    
    var formData = new FormData();
    formData.append('email', email);
    formData.append('type', 'student');
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "store:send_verification_code" %}', {
        method: 'POST',
        body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            messageEl.innerHTML = '<span style="color: #059669;">' + data.message + '</span>';
            document.getElementById('edu-code-section').style.display = 'block';
            document.getElementById('edu-send-btn').style.display = 'none';
            document.getElementById('edu-verify-btn').style.display = 'block';
            emailInput.disabled = true;
        } else {
            messageEl.innerHTML = '<span style="color: #dc2626;">' + data.message + '</span>';
        }
    })
    .catch(function(error) {
        messageEl.innerHTML = '<span style="color: #dc2626;">L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.</span>';
    });
}

/**
 * X√°c minh m√£ OTP ƒë∆∞·ª£c g·ª≠i v·ªÅ email
 * S·ª≠ d·ª•ng Django URL v√† CSRF token
 */
function verifyEduCode() {
    var codeInput = document.getElementById('edu-code');
    var messageEl = document.getElementById('edu-message');
    var code = codeInput.value.trim();
    
    if (!code || code.length !== 6) {
        messageEl.innerHTML = '<span style="color: #dc2626;">Vui l√≤ng nh·∫≠p m√£ 6 s·ªë</span>';
        return;
    }
    
    messageEl.innerHTML = '<span style="color: #059669;">ƒêang x√°c th·ª±c...</span>';
    
    var formData = new FormData();
    formData.append('email', currentEduEmail);
    formData.append('code', code);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('{% url "store:verify_code" %}', {
        method: 'POST',
        body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            messageEl.innerHTML = '<span style="color: #059669;">' + data.message + '</span>';
            setTimeout(function() {
                location.reload();
            }, 1500);
        } else {
            messageEl.innerHTML = '<span style="color: #dc2626;">' + data.message + '</span>';
        }
    })
    .catch(function(error) {
        messageEl.innerHTML = '<span style="color: #dc2626;">L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.</span>';
    });
}
</script>
{% endblock %}
