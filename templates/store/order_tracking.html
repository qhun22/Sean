{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}TRA CỨU ĐƠN - QHUN22 Mobile{% endblock %}

{% block content %}
<style>
/* ==================== ORDER TRACKING PAGE ====================
   Đồng bộ design system: CSS variables, card pattern, checkout-item layout
   =========================================================== */
.qh-ot-page { /* Inherits .qh-main */ }

/* ===== Single Order Card ===== */
.qh-ot-card {
    background: var(--qh-card-bg, var(--qh-white));
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    overflow: hidden;
    transition: box-shadow 0.2s;
}
.qh-ot-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.09);
}
.qh-ot-card + .qh-ot-card {
    margin-top: 20px;
}

/* ===== Collapsible header ===== */
.qh-ot-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    padding: 20px 24px;
    border: none;
    background: none;
    cursor: pointer;
    text-align: left;
    font-family: 'Signika', sans-serif;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s;
}
.qh-ot-card.open .qh-ot-toggle {
    border-bottom-color: var(--qh-border);
}
.qh-ot-left-info {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
}
.qh-ot-code {
    font-size: 17px;
    font-weight: 700;
    color: var(--qh-text);
    letter-spacing: 0.5px;
}
.qh-ot-code span { color: var(--qh-primary); }
.qh-ot-date {
    font-size: 13px;
    color: var(--qh-text-light);
}
.qh-ot-right-info {
    display: flex;
    align-items: center;
    gap: 10px;
}
.qh-ot-chevron {
    width: 20px; height: 20px;
    color: var(--qh-text-light);
    transition: transform 0.3s;
    flex-shrink: 0;
}
.qh-ot-card.open .qh-ot-chevron {
    transform: rotate(180deg);
}

/* ===== Status badge ===== */
.qh-ot-status {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    flex-shrink: 0;
}
.qh-ot-status svg { width: 14px; height: 14px; }
.qh-ot-status.pending    { background: #fef3c7; color: #d97706; }
.qh-ot-status.processing { background: #dbeafe; color: #2563eb; }
.qh-ot-status.shipped    { background: #e0e7ff; color: #4f46e5; }
.qh-ot-status.delivered  { background: #d1fae5; color: #059669; }
.qh-ot-status.cancelled  { background: #fee2e2; color: #dc2626; }

/* ===== Collapsible body ===== */
.qh-ot-body {
    display: none;
}
.qh-ot-card.open .qh-ot-body {
    display: block;
}

/* ===== Progress stepper (horizontal) ===== */
.qh-ot-progress {
    padding: 28px 24px;
    border-bottom: 1px solid var(--qh-border);
}
.qh-ot-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    max-width: 600px;
    margin: 0 auto;
}
/* Track line BG */
.qh-ot-steps::before {
    content: '';
    position: absolute;
    top: 18px;
    left: 36px;
    right: 36px;
    height: 3px;
    background: var(--qh-border);
    z-index: 0;
}
/* Track line active */
.qh-ot-steps::after {
    content: '';
    position: absolute;
    top: 18px;
    left: 36px;
    height: 3px;
    background: linear-gradient(90deg, var(--qh-primary), var(--qh-primary-dark));
    z-index: 1;
    transition: width 0.6s ease;
}
.qh-ot-steps[data-progress="0"]::after { width: 0%; }
.qh-ot-steps[data-progress="1"]::after { width: calc((100% - 72px) * 0.33); }
.qh-ot-steps[data-progress="2"]::after { width: calc((100% - 72px) * 0.66); }
.qh-ot-steps[data-progress="3"]::after { width: calc(100% - 72px); }

.qh-ot-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    z-index: 2;
    flex: 1;
}
.qh-ot-step-dot {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: var(--qh-bg);
    border: 3px solid var(--qh-border);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}
.qh-ot-step-dot i {
    font-size: 15px;
    color: #9ca3af;
    transition: color 0.3s;
}
.qh-ot-step.active .qh-ot-step-dot {
    background: var(--qh-primary);
    border-color: var(--qh-primary);
    box-shadow: 0 0 0 4px rgba(169,204,240,0.3);
}
.qh-ot-step.active .qh-ot-step-dot i,
.qh-ot-step.done .qh-ot-step-dot i { color: #fff; }
.qh-ot-step.done .qh-ot-step-dot {
    background: var(--qh-primary);
    border-color: var(--qh-primary);
}
.qh-ot-step-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--qh-text-light);
    text-align: center;
}
.qh-ot-step.active .qh-ot-step-label,
.qh-ot-step.done .qh-ot-step-label {
    color: var(--qh-text);
    font-weight: 600;
}

/* ===== Product items — 1:1 checkout-item pattern ===== */
.qh-ot-items {
    padding: 20px 24px 0;
    border-bottom: 1px solid var(--qh-border);
}
.qh-ot-items-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--qh-text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
}
.qh-ot-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 0;
    border-top: 1px solid var(--qh-border);
}
.qh-ot-item:first-of-type {
    border-top: none;
}
.qh-ot-item-img {
    width: 72px; height: 72px;
    min-width: 72px;
    border-radius: 10px;
    overflow: hidden;
    background: #f5f5f5;
    flex-shrink: 0;
}
.qh-ot-item-img img {
    width: 100%; height: 100%;
    object-fit: cover;
}
.qh-ot-item-img .qh-ot-no-img {
    width: 100%; height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #d1d5db;
    font-size: 28px;
}
.qh-ot-item-info {
    flex: 1;
    min-width: 0;
}
.qh-ot-item-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--qh-text);
    margin-bottom: 4px;
    line-height: 1.4;
}
.qh-ot-item-meta {
    font-size: 13px;
    color: var(--qh-text-light);
    line-height: 1.6;
}
.qh-ot-item-price {
    text-align: right;
    white-space: nowrap;
}
.qh-ot-item-amount {
    font-size: 15px;
    font-weight: 700;
    color: var(--qh-text);
}

/* ===== Footer summary ===== */
.qh-ot-footer {
    padding: 16px 24px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
}
.qh-ot-payment {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    background: #f3f4f6;
    color: var(--qh-text-light);
}
.qh-ot-payment i { font-size: 15px; }
.qh-ot-payment.cod   { background: #fef3c7; color: #92400e; }
.qh-ot-payment.vietqr{ background: #dbeafe; color: #1d4ed8; }
.qh-ot-payment.vnpay { background: #ede9fe; color: #6d28d9; }
.qh-ot-grand-total {
    font-size: 18px;
    font-weight: 700;
    color: var(--qh-primary);
}

/* ===== Empty State ===== */
.qh-ot-empty {
    background: var(--qh-card-bg, var(--qh-white));
    border-radius: 12px;
    padding: 60px 24px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.qh-ot-empty-icon {
    width: 100px; height: 100px;
    margin: 0 auto 20px;
    color: #d1d5db;
}
.qh-ot-empty h3 {
    font-size: 20px;
    font-weight: 700;
    color: var(--qh-text);
    margin-bottom: 8px;
}
.qh-ot-empty p {
    font-size: 15px;
    color: var(--qh-text-light);
    margin-bottom: 24px;
}
.qh-ot-empty-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 32px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    text-decoration: none;
    background: linear-gradient(135deg, var(--qh-primary), var(--qh-primary-dark));
    color: var(--qh-text);
    box-shadow: 0 4px 12px rgba(169,204,240,0.4);
    transition: all 0.2s;
}
.qh-ot-empty-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(169,204,240,0.5);
}

/* ===== Cancel button ===== */
.qh-ot-cancel-wrap {
    padding: 0 24px 16px;
    display: flex;
    justify-content: flex-end;
}
.qh-ot-cancel-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 20px;
    border-radius: 8px;
    font-family: 'Signika', sans-serif;
    font-size: 13px;
    font-weight: 600;
    border: 1.5px solid #fca5a5;
    background: #fff;
    color: #dc2626;
    cursor: pointer;
    transition: all 0.2s;
}
.qh-ot-cancel-btn:hover {
    background: #fef2f2;
    border-color: #dc2626;
}
.qh-ot-cancel-btn i { font-size: 15px; }

/* ===== Responsive ===== */
@media (max-width: 768px) {
    .qh-ot-toggle { padding: 16px; gap: 8px; }
    .qh-ot-left-info { gap: 8px; }
    .qh-ot-code { font-size: 15px; }
    .qh-ot-progress { padding: 20px 16px; }
    .qh-ot-steps {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
        padding-left: 18px;
        max-width: 100%;
    }
    .qh-ot-steps::before,
    .qh-ot-steps::after {
        top: 0; bottom: 0;
        left: 18px; right: auto;
        width: 3px !important;
        height: auto !important;
    }
    .qh-ot-steps[data-progress="0"]::after { height: 0% !important; width: 3px !important; }
    .qh-ot-steps[data-progress="1"]::after { height: 33% !important; width: 3px !important; }
    .qh-ot-steps[data-progress="2"]::after { height: 66% !important; width: 3px !important; }
    .qh-ot-steps[data-progress="3"]::after { height: 100% !important; width: 3px !important; }
    .qh-ot-step { flex-direction: row; gap: 12px; }
    .qh-ot-items { padding: 16px 16px 0; }
    .qh-ot-item-img { width: 56px; height: 56px; min-width: 56px; }
    .qh-ot-footer { padding: 12px 16px 16px; }
}
@media (max-width: 480px) {
    .qh-ot-right-info { flex-wrap: wrap; }
}
</style>

<div class="qh-ot-page">
    <h1 class="qh-page-title">TRA CỨU ĐƠN HÀNG</h1>

    {% if orders %}
    {% for order in orders %}
    <div class="qh-ot-card{% if forloop.first %} open{% endif %}" data-order="{{ order.order_code }}">
        <!-- Toggle header -->
        <button class="qh-ot-toggle" onclick="toggleOrder(this)">
            <div class="qh-ot-left-info">
                <div class="qh-ot-code"><span>{{ order.order_code }}</span></div>
                <div class="qh-ot-date">{{ order.created_at|date:"d/m/Y — H:i" }}</div>
            </div>
            <div class="qh-ot-right-info">
                <span class="qh-ot-status {{ order.status }}">
                    {% if order.status == 'pending' %}
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Chờ xử lý
                    {% elif order.status == 'processing' %}
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        Đang xử lý
                    {% elif order.status == 'shipped' %}
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/></svg>
                        Đang giao
                    {% elif order.status == 'delivered' %}
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Đã giao
                    {% elif order.status == 'cancelled' %}
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Đã hủy
                    {% endif %}
                </span>
                <svg class="qh-ot-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </button>

        <!-- Collapsible body -->
        <div class="qh-ot-body">

            <!-- Progress steps (not cancelled) -->
            {% if order.status != 'cancelled' %}
            <div class="qh-ot-progress">
                {% with s=order.status %}
                <div class="qh-ot-steps" data-progress="{% if s == 'pending' %}0{% elif s == 'processing' %}1{% elif s == 'shipped' %}2{% elif s == 'delivered' %}3{% endif %}">
                    <div class="qh-ot-step {% if s == 'pending' %}active{% elif s == 'processing' or s == 'shipped' or s == 'delivered' %}done{% endif %}">
                        <div class="qh-ot-step-dot"><i class="ri-file-list-3-line"></i></div>
                        <span class="qh-ot-step-label">Đã đặt hàng</span>
                    </div>
                    <div class="qh-ot-step {% if s == 'processing' %}active{% elif s == 'shipped' or s == 'delivered' %}done{% endif %}">
                        <div class="qh-ot-step-dot"><i class="ri-settings-3-line"></i></div>
                        <span class="qh-ot-step-label">Đang xử lý</span>
                    </div>
                    <div class="qh-ot-step {% if s == 'shipped' %}active{% elif s == 'delivered' %}done{% endif %}">
                        <div class="qh-ot-step-dot"><i class="ri-truck-line"></i></div>
                        <span class="qh-ot-step-label">Đang giao</span>
                    </div>
                    <div class="qh-ot-step {% if s == 'delivered' %}active done{% endif %}">
                        <div class="qh-ot-step-dot"><i class="ri-checkbox-circle-line"></i></div>
                        <span class="qh-ot-step-label">Đã giao hàng</span>
                    </div>
                </div>
                {% endwith %}
            </div>
            {% endif %}

            <!-- Product items -->
            {% if order.items.all %}
            <div class="qh-ot-items">
                <div class="qh-ot-items-title">Sản phẩm ({{ order.items.count }})</div>
                {% for item in order.items.all %}
                <div class="qh-ot-item">
                    <div class="qh-ot-item-img">
                        {% if item.thumbnail %}
                        <img src="{{ item.thumbnail }}" alt="{{ item.product_name }}" loading="lazy">
                        {% else %}
                        <div class="qh-ot-no-img"><i class="ri-image-line"></i></div>
                        {% endif %}
                    </div>
                    <div class="qh-ot-item-info">
                        <div class="qh-ot-item-name">{{ item.product_name }}</div>
                        <div class="qh-ot-item-meta">
                            {% if item.color_name %}{{ item.color_name }}{% endif %}{% if item.color_name and item.storage %} · {% endif %}{% if item.storage %}{{ item.storage }}{% endif %}{% if item.quantity > 1 %} · SL: {{ item.quantity }}{% endif %}
                        </div>
                    </div>
                    <div class="qh-ot-item-price">
                        <div class="qh-ot-item-amount">{{ item.price|format_price_with_unit }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Footer: payment + total -->
            <div class="qh-ot-footer">
                <span class="qh-ot-payment {{ order.payment_method }}">
                    {% if order.payment_method == 'cod' %}
                        <i class="ri-hand-coin-line"></i> COD
                    {% elif order.payment_method == 'vietqr' %}
                        <i class="ri-qr-code-line"></i> VietQR
                    {% elif order.payment_method == 'vnpay' %}
                        <i class="ri-bank-card-line"></i> VNPay
                    {% else %}
                        <i class="ri-secure-payment-line"></i> {{ order.get_payment_method_display }}
                    {% endif %}
                </span>
                <div class="qh-ot-grand-total">{{ order.total_amount|format_price_with_unit }}</div>
            </div>

            <!-- Cancel button (only for pending/processing) -->
            {% if order.status == 'pending' or order.status == 'processing' %}
            <div class="qh-ot-cancel-wrap">
                <button class="qh-ot-cancel-btn" onclick="cancelOrder('{{ order.order_code }}', this)">
                    <i class="ri-close-circle-line"></i> Hủy đơn hàng
                </button>
            </div>
            {% endif %}

        </div>
    </div>
    {% endfor %}

    {% else %}
    <!-- Empty State -->
    <div class="qh-ot-empty">
        <svg class="qh-ot-empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
        </svg>
        <h3>Chưa có đơn hàng nào</h3>
        <p>Hãy mua sắm để đơn hàng của bạn xuất hiện tại đây!</p>
        <a href="{% url 'store:home' %}" class="qh-ot-empty-btn">
            <i class="ri-shopping-bag-line"></i> Tiếp tục mua sắm
        </a>
    </div>
    {% endif %}
</div>

<script>
function toggleOrder(btn) {
    var card = btn.closest('.qh-ot-card');
    card.classList.toggle('open');
}
function cancelOrder(code, btn) {
    if (!confirm('Bạn có chắc muốn hủy đơn hàng ' + code + ' không?')) return;
    btn.disabled = true;
    btn.innerHTML = '<i class="ri-loader-4-line"></i> Đang hủy...';
    fetch('/api/cancel-order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken')
        },
        body: JSON.stringify({order_code: code})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.success) {
            if (window.QHToast) QHToast.show('Đã hủy đơn hàng ' + code, 'success');
            setTimeout(function() { location.reload(); }, 800);
        } else {
            if (window.QHToast) QHToast.show(d.message || 'Không thể hủy đơn hàng', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-close-circle-line"></i> Hủy đơn hàng';
        }
    })
    .catch(function() {
        if (window.QHToast) QHToast.show('Lỗi kết nối', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="ri-close-circle-line"></i> Hủy đơn hàng';
    });
}
function getCookie(name) {
    var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
}
</script>
{% csrf_token %}
{% endblock %}
