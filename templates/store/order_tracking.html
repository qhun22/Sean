{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}TRA CỨU ĐƠN - QHUN22 Mobile{% endblock %}

{% block content %}
<style>
/* ==================== ORDER TRACKING PAGE (Table Design) ==================== */
.qh-ot-page { }
.qh-ot-page .qh-page-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--qh-text);
    margin-bottom: 24px;
}
.qh-ot-table-wrap {
    overflow-x: auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.qh-ot-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}
.qh-ot-table thead tr {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}
.qh-ot-table th {
    padding: 13px 14px;
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    white-space: nowrap;
    text-align: left;
}
.qh-ot-table th.center { text-align: center; }
.qh-ot-table th.right  { text-align: right; }
.qh-ot-table td {
    padding: 13px 14px;
    color: #1e293b;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
}
.qh-ot-table td.center { text-align: center; }
.qh-ot-table td.right  { text-align: right; }
.qh-ot-table td.stt    { text-align: center; color: #64748b; }
.qh-ot-table td.name   { font-weight: 500; }
.qh-ot-table td.qty    { text-align: center; color: #64748b; }
.qh-ot-table td.color  { text-align: center; color: #64748b; }
.qh-ot-table td.storage{ text-align: center; color: #64748b; }
.qh-ot-table td.price  { text-align: right; font-weight: 600; white-space: nowrap; }
.qh-ot-table td.date   { color: #64748b; font-size: 13px; white-space: nowrap; }
.qh-ot-table td.code   { color: #3b82f6; font-weight: 600; font-family: monospace; font-size: 13px; white-space: nowrap; }
.qh-ot-table td.detail-cell { text-align: center; }

/* Status badges */
.qh-ot-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
}
.qh-ot-badge.pending    { background: #fef3c7; color: #92400e; }
.qh-ot-badge.processing { background: #dbeafe; color: #1e40af; }
.qh-ot-badge.shipped    { background: #e0e7ff; color: #3730a3; }
.qh-ot-badge.delivered  { background: #d1fae5; color: #065f46; }
.qh-ot-badge.cancelled  { background: #fee2e2; color: #991b1b; }
.qh-ot-badge.refunding { background: #fce7f3; color: #9d174d; }

/* Detail button */
.qh-ot-detail-btn {
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 14px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    font-family: 'Signika', sans-serif;
    transition: background 0.2s;
}
.qh-ot-detail-btn:hover { background: #2563eb; }

/* Filter bar */
.qh-ot-filter-bar {
    display: flex;
    align-items: center;
    gap: 0;
    margin-top: 20px;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.qh-ot-filter-btn {
    flex: 1;
    padding: 14px 8px;
    border: none;
    background: white;
    font-size: 14px;
    font-weight: 500;
    color: #64748b;
    cursor: pointer;
    font-family: 'Signika', sans-serif;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    text-align: center;
}
.qh-ot-filter-btn:hover { background: #f8fafc; }
.qh-ot-filter-btn.active {
    color: #3b82f6;
    font-weight: 600;
    border-bottom-color: #3b82f6;
}

/* Detail Modal */
.qh-ot-modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}
.qh-ot-modal-overlay.show { display: flex; }
.qh-ot-modal {
    background: white;
    border-radius: 12px;
    width: 700px;
    max-width: 95%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.qh-ot-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e2e8f0;
    flex-shrink: 0;
}
.qh-ot-modal-header h3 {
    font-size: 18px;
    font-weight: 600;
    font-family: 'Signika', sans-serif;
    margin: 0;
    color: #1e293b;
}
.qh-ot-modal-close {
    padding: 8px 16px;
    background: #f1f5f9;
    color: #334155;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-family: 'Signika', sans-serif;
}
.qh-ot-modal-close:hover { background: #e2e8f0; }

/* Custom Confirm Modal */
.qh-ot-confirm-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}
.qh-ot-confirm-overlay.show { display: flex; }
.qh-ot-confirm-modal {
    background: white;
    border-radius: 12px;
    width: 400px;
    max-width: 90%;
    padding: 24px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
.qh-ot-confirm-icon {
    width: 60px; height: 60px;
    margin: 0 auto 16px;
    color: #ef4444;
}
.qh-ot-confirm-title {
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 8px;
}
.qh-ot-confirm-text {
    font-size: 14px;
    color: #64748b;
    margin-bottom: 24px;
}
.qh-ot-confirm-btns {
    display: flex;
    gap: 12px;
    justify-content: center;
}
.qh-ot-confirm-btn {
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    font-family: 'Signika', sans-serif;
    transition: all 0.2s;
}
.qh-ot-confirm-btn.cancel {
    background: #f1f5f9;
    color: #64748b;
}
.qh-ot-confirm-btn.cancel:hover { background: #e2e8f0; }
.qh-ot-confirm-btn.danger {
    background: #ef4444;
    color: white;
}
.qh-ot-confirm-btn.danger:hover { background: #dc2626; }

.qh-ot-modal-body {
    padding: 20px 24px;
    overflow-y: auto;
    flex: 1;
}
.qh-ot-modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-shrink: 0;
    flex-wrap: wrap;
}

/* Detail sections */
.qh-ot-detail-block {
    background: #f8fafc;
    border-radius: 8px;
    padding: 14px 18px;
    margin-bottom: 16px;
}
.qh-ot-detail-block h4 {
    font-size: 14px;
    font-weight: 600;
    color: #334155;
    margin: 0 0 10px;
}
.qh-ot-detail-items-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
.qh-ot-detail-items-table thead tr {
    background: #f1f5f9;
    text-align: left;
}
.qh-ot-detail-items-table th,
.qh-ot-detail-items-table td {
    padding: 8px 10px;
}
.qh-ot-detail-items-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
}
.qh-ot-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    font-size: 13px;
}
.qh-ot-info-label { color: #64748b; }
.qh-ot-info-value { color: #1e293b; text-align: right; }
.qh-ot-total-row {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Cancel btn in modal */
.qh-ot-modal-cancel-btn {
    padding: 8px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: 1.5px solid #fca5a5;
    background: #fff;
    color: #dc2626;
    font-family: 'Signika', sans-serif;
    transition: all 0.2s;
}
.qh-ot-modal-cancel-btn:hover {
    background: #fef2f2;
    border-color: #dc2626;
}

/* ===== Empty State ===== */
.qh-ot-empty {
    background: var(--qh-card-bg, var(--qh-white));
    border-radius: 12px;
    padding: 60px 24px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.qh-ot-empty-icon {
    width: 100px; height: 100px;
    margin: 0 auto 20px;
    color: #d1d5db;
}
.qh-ot-empty h3 {
    font-size: 20px;
    font-weight: 700;
    color: var(--qh-text);
    margin-bottom: 8px;
}
.qh-ot-empty p {
    font-size: 15px;
    color: var(--qh-text-light);
    margin-bottom: 24px;
}
.qh-ot-empty-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 32px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    text-decoration: none;
    background: linear-gradient(135deg, var(--qh-primary), var(--qh-primary-dark));
    color: var(--qh-text);
    box-shadow: 0 4px 12px rgba(169,204,240,0.4);
    transition: all 0.2s;
}
.qh-ot-empty-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(169,204,240,0.5);
}

/* ===== Responsive ===== */
@media (max-width: 768px) {
    .qh-ot-table { font-size: 13px; }
    .qh-ot-table th, .qh-ot-table td { padding: 10px 8px; }
    .qh-ot-filter-btn { font-size: 12px; padding: 12px 4px; }
    .qh-ot-modal { width: 95%; }
}
</style>

<div class="qh-ot-page">
    <h1 class="qh-page-title">TRA CỨU ĐƠN HÀNG</h1>

    {% if orders %}

    <!-- Orders Table -->
    <div class="qh-ot-table-wrap">
        <table class="qh-ot-table">
            <thead>
                <tr>
                    <th class="center">STT</th>
                    <th>Tên sản phẩm</th>
                    <th class="center">Số lượng</th>
                    <th class="center">Màu sắc</th>
                    <th class="center">Dung lượng</th>
                    <th class="right">Giá</th>
                    <th>Ngày đặt hàng</th>
                    <th>Mã đơn hàng</th>
                    <th class="center">Trạng thái</th>
                    <th class="center">Chi tiết</th>
                </tr>
            </thead>
            <tbody id="otTableBody">
                {% with counter=0 %}
                {% for order in orders %}
                    {% for item in order.items.all %}
                    <tr data-status="{{ order.status }}" data-order-id="{{ order.id }}">
                        <td class="stt"></td>
                        <td class="name">{{ item.product_name }}</td>
                        <td class="qty">{{ item.quantity }}</td>
                        <td class="color">{{ item.color_name|default:"—" }}</td>
                        <td class="storage">{{ item.storage|default:"—" }}</td>
                        <td class="price">{{ item.price|format_price_with_unit }}</td>
                        <td class="date">{{ order.created_at|date:"d/m/Y H:i" }}</td>
                        <td class="code">{{ order.order_code }}</td>
                        <td class="center">
                            {% if order.status == 'cancelled' and order.refund_status == 'pending' %}
                            <span class="qh-ot-badge refunding">Chờ hoàn tiền</span>
                            {% elif order.status == 'cancelled' and order.refund_status == 'completed' %}
                            <span class="qh-ot-badge delivered">Đã tất toán</span>
                            {% elif order.status == 'cancelled' %}
                            <span class="qh-ot-badge cancelled">Đã hủy</span>
                            {% else %}
                            <span class="qh-ot-badge {{ order.status }}">{{ order.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td class="detail-cell">
                            <button class="qh-ot-detail-btn" onclick="openOtDetail('{{ order.order_code }}')">Xem</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr data-status="{{ order.status }}" data-order-id="{{ order.id }}">
                        <td class="stt"></td>
                        <td class="name">—</td>
                        <td class="qty">0</td>
                        <td class="color">—</td>
                        <td class="storage">—</td>
                        <td class="price">{{ order.total_amount|format_price_with_unit }}</td>
                        <td class="date">{{ order.created_at|date:"d/m/Y H:i" }}</td>
                        <td class="code">{{ order.order_code }}</td>
                        <td class="center">
                            {% if order.status == 'cancelled' and order.refund_status == 'pending' %}
                            <span class="qh-ot-badge refunding">Chờ hoàn tiền</span>
                            {% elif order.status == 'cancelled' and order.refund_status == 'completed' %}
                            <span class="qh-ot-badge delivered">Đã tất toán</span>
                            {% elif order.status == 'cancelled' %}
                            <span class="qh-ot-badge cancelled">Đã hủy</span>
                            {% else %}
                            <span class="qh-ot-badge {{ order.status }}">{{ order.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td class="detail-cell">
                            <button class="qh-ot-detail-btn" onclick="openOtDetail('{{ order.order_code }}')">Xem</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
                {% endwith %}
            </tbody>
        </table>
    </div>

    {% comment %} <!-- Status Filter Buttons -->
    <div class="qh-ot-filter-bar">
        <button type="button" class="qh-ot-filter-btn active" data-filter="all" onclick="filterOtOrders('all')">Tất cả</button>
        <button type="button" class="qh-ot-filter-btn" data-filter="pending" onclick="filterOtOrders('pending')">Đã đặt hàng</button>
        <button type="button" class="qh-ot-filter-btn" data-filter="processing" onclick="filterOtOrders('processing')">Đang xử lý</button>
        <button type="button" class="qh-ot-filter-btn" data-filter="shipped" onclick="filterOtOrders('shipped')">Đang giao</button>
        <button type="button" class="qh-ot-filter-btn" data-filter="delivered" onclick="filterOtOrders('delivered')">Đã giao hàng</button>
        <button type="button" class="qh-ot-filter-btn" data-filter="cancelled" onclick="filterOtOrders('cancelled')">Hủy đơn</button>
    </div> {% endcomment %}

    <!-- Detail Modal -->
    <div class="qh-ot-modal-overlay" id="otDetailModal" onclick="closeOtDetailOnClickOutside(event)">
        <div class="qh-ot-modal" onclick="event.stopPropagation()">
            <div class="qh-ot-modal-header">
                <h3>Chi tiết đơn hàng</h3>
                <button class="qh-ot-modal-close" onclick="closeOtDetail()">Đóng</button>
            </div>
            <div class="qh-ot-modal-body" id="otDetailBody">
                <p style="text-align: center; color: #94a3b8;">Đang tải...</p>
            </div>
            <div class="qh-ot-modal-footer" id="otDetailFooter"></div>
        </div>
    </div>

    <!-- Confirm Cancel Modal -->
    <div class="qh-ot-confirm-overlay" id="otConfirmModal">
        <div class="qh-ot-confirm-modal">
            <svg class="qh-ot-confirm-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <h3 class="qh-ot-confirm-title">Xác nhận hủy đơn</h3>
            <p class="qh-ot-confirm-text" id="otConfirmText">Bạn có chắc muốn hủy đơn hàng này?</p>
            <div class="qh-ot-confirm-btns">
                <button class="qh-ot-confirm-btn cancel" onclick="closeOtConfirm()">Hủy bỏ</button>
                <button class="qh-ot-confirm-btn danger" id="otConfirmBtn">Xác nhận hủy</button>
            </div>
        </div>
    </div>

    <!-- Refund Info Modal for VNPay/VietQR -->
    <div class="qh-ot-confirm-overlay" id="otRefundModal">
        <div class="qh-ot-confirm-modal" style="width: 420px;">
            <svg class="qh-ot-confirm-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #3b82f6;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
            </svg>
            <h3 class="qh-ot-confirm-title">Thông tin hoàn tiền</h3>
            <p class="qh-ot-confirm-text">Đơn hàng thanh toán qua VNPay/VietQR. Vui lòng nhập thông tin để hoàn tiền.</p>
            <div style="text-align: left; margin-bottom: 20px;">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #334155; margin-bottom: 6px;">Số tài khoản</label>
                <input type="text" id="otRefundAccount" placeholder="Nhập số tài khoản" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box; font-family: 'Signika', sans-serif;">
                <label style="display: block; font-size: 13px; font-weight: 600; color: #334155; margin-bottom: 6px; margin-top: 12px;">Ngân hàng</label>
                <input type="text" id="otRefundBank" placeholder="Nhập tên ngân hàng" style="width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box; font-family: 'Signika', sans-serif;">
            </div>
            <div class="qh-ot-confirm-btns">
                <button class="qh-ot-confirm-btn cancel" onclick="closeOtRefundModal()">Hủy bỏ</button>
                <button class="qh-ot-confirm-btn danger" id="otRefundBtn" onclick="submitOtRefund()">Xác nhận hoàn tiền</button>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="qh-ot-empty">
        <svg class="qh-ot-empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
        </svg>
        <h3>Chưa có đơn hàng nào</h3>
        <p>Hãy mua sắm để đơn hàng của bạn xuất hiện tại đây!</p>
        <a href="{% url 'store:home' %}" class="qh-ot-empty-btn">
            <i class="ri-shopping-bag-line"></i> Tiếp tục mua sắm
        </a>
    </div>
    {% endif %}
</div>

<!-- Embed order data as JSON for detail modal -->
<script>
var OT_ORDERS = {};
{% for order in orders %}
OT_ORDERS['{{ order.order_code }}'] = {
    order_code: '{{ order.order_code }}',
    status: '{{ order.status }}',
    status_display: '{{ order.get_status_display }}',
    refund_status: '{{ order.refund_status }}',
    payment_method: '{{ order.payment_method }}',
    payment_display: '{{ order.get_payment_method_display }}',
    created_at: '{{ order.created_at|date:"d/m/Y H:i" }}',
    total_amount: '{{ order.total_amount }}',
    items: [
        {% for item in order.items.all %}
        {
            product_name: '{{ item.product_name|escapejs }}',
            quantity: {{ item.quantity }},
            color_name: '{{ item.color_name|default:"—"|escapejs }}',
            storage: '{{ item.storage|default:"—"|escapejs }}',
            price: '{{ item.price }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
};
{% endfor %}

/* ===== Number STT rows ===== */
(function() {
    var rows = document.querySelectorAll('#otTableBody tr[data-status]');
    for (var i = 0; i < rows.length; i++) {
        var sttCell = rows[i].querySelector('.stt');
        if (sttCell) sttCell.textContent = i + 1;
    }
})();

/* ===== Filter ===== */
function filterOtOrders(status) {
    var rows = document.querySelectorAll('#otTableBody tr[data-status]');
    var stt = 0;
    for (var i = 0; i < rows.length; i++) {
        var r = rows[i];
        if (status === 'all' || r.getAttribute('data-status') === status) {
            r.style.display = '';
            stt++;
            var sttCell = r.querySelector('.stt');
            if (sttCell) sttCell.textContent = stt;
        } else {
            r.style.display = 'none';
        }
    }
    // Update active button
    var btns = document.querySelectorAll('.qh-ot-filter-btn');
    btns.forEach(function(b) {
        if (b.getAttribute('data-filter') === status) {
            b.classList.add('active');
        } else {
            b.classList.remove('active');
        }
    });
}

/* ===== Detail Modal ===== */
var _otCurrentCode = null;

function openOtDetail(code) {
    _otCurrentCode = code;
    var modal = document.getElementById('otDetailModal');
    var body = document.getElementById('otDetailBody');
    var footer = document.getElementById('otDetailFooter');
    modal.classList.add('show');

    var o = OT_ORDERS[code];
    if (!o) {
        body.innerHTML = '<p style="text-align:center;color:#ef4444;">Không tìm thấy đơn hàng</p>';
        footer.innerHTML = '';
        return;
    }

    var html = '';

    // Items table
    html += '<div style="margin-bottom: 16px;">';
    html += '<h4 style="font-size:14px;font-weight:600;color:#334155;margin:0 0 10px;">Sản phẩm</h4>';
    html += '<table class="qh-ot-detail-items-table"><thead><tr>';
    html += '<th>Tên SP</th><th style="text-align:center;">SL</th><th>Màu</th><th>Bộ nhớ</th><th style="text-align:right;">Giá</th>';
    html += '</tr></thead><tbody>';
    o.items.forEach(function(item) {
        html += '<tr>';
        html += '<td style="color:#1e293b;font-weight:500;">' + escOtHtml(item.product_name) + '</td>';
        html += '<td style="text-align:center;color:#64748b;">' + item.quantity + '</td>';
        html += '<td style="color:#64748b;">' + escOtHtml(item.color_name) + '</td>';
        html += '<td style="color:#64748b;">' + escOtHtml(item.storage) + '</td>';
        html += '<td style="text-align:right;color:#1e293b;font-weight:600;">' + fmtOtVND(item.price) + '</td>';
        html += '</tr>';
    });
    html += '</tbody></table></div>';

    // Order info
    html += '<div class="qh-ot-detail-block">';
    html += '<div class="qh-ot-info-grid">';
    html += otInfoRow('Mã đơn hàng', '<span style="color:#3b82f6;font-weight:600;font-family:monospace;">' + escOtHtml(o.order_code) + '</span>');
    html += otInfoRow('Hình thức TT', otPayBadge(o.payment_method, o.payment_display));
    html += otInfoRow('Ngày đặt', escOtHtml(o.created_at));
    // Hiển thị trạng thái theo logic mới
    var statusHtml = '';
    if (o.status === 'cancelled' && o.refund_status === 'pending') {
        statusHtml = '<span class="qh-ot-badge refunding">Chờ hoàn tiền</span>';
    } else if (o.status === 'cancelled' && o.refund_status === 'completed') {
        statusHtml = '<span class="qh-ot-badge delivered">Đã tất toán</span>';
    } else if (o.status === 'cancelled') {
        statusHtml = '<span class="qh-ot-badge cancelled">Đã hủy</span>';
    } else {
        statusHtml = '<span class="qh-ot-badge ' + o.status + '">' + escOtHtml(o.status_display) + '</span>';
    }
    html += otInfoRow('Trạng thái', statusHtml);
    html += '</div>';
    html += '<div class="qh-ot-total-row">';
    html += '<span style="font-size:14px;font-weight:600;color:#334155;">Tổng cộng</span>';
    html += '<span style="font-size:18px;font-weight:700;color:#ef4444;">' + fmtOtVND(o.total_amount) + '</span>';
    html += '</div></div>';

    body.innerHTML = html;

    // Footer: cancel button if pending/processing
    footer.innerHTML = '';
    if (o.status === 'pending' || o.status === 'processing') {
        var cancelBtn = document.createElement('button');
        cancelBtn.className = 'qh-ot-modal-cancel-btn';
        cancelBtn.innerHTML = '<i class="ri-close-circle-line"></i> Hủy đơn hàng';
        cancelBtn.onclick = function() { cancelOtOrder(o.order_code, cancelBtn, o.payment_method); };
        footer.appendChild(cancelBtn);
    }
}

function closeOtDetail() {
    document.getElementById('otDetailModal').classList.remove('show');
    _otCurrentCode = null;
}

function closeOtDetailOnClickOutside(event) {
    if (event.target.classList.contains('qh-ot-modal-overlay')) {
        closeOtDetail();
    }
}

var _otConfirmCallback = null;

function showOtConfirm(message, callback) {
    document.getElementById('otConfirmText').textContent = message;
    document.getElementById('otConfirmModal').classList.add('show');
    _otConfirmCallback = callback;
    document.getElementById('otConfirmBtn').onclick = function() {
        closeOtConfirm();
        if (_otConfirmCallback) _otConfirmCallback();
    };
}

function closeOtConfirm() {
    document.getElementById('otConfirmModal').classList.remove('show');
    _otConfirmCallback = null;
}
// ...existing code...

/* ===== Helpers ===== */
function escOtHtml(s) {
    if (!s) return '';
    var d = document.createElement('div');
    d.appendChild(document.createTextNode(s));
    return d.innerHTML;
}
function fmtOtVND(v) {
    var n = parseInt(v, 10);
    if (isNaN(n)) return '0đ';
    return n.toLocaleString('vi-VN') + 'đ';
}
function otInfoRow(label, value) {
    return '<span class="qh-ot-info-label">' + label + '</span><span class="qh-ot-info-value">' + value + '</span>';
}
function otPayBadge(key, display) {
    var cls = {cod: 'pending', vietqr: 'processing', vnpay: 'shipped'};
    return '<span class="qh-ot-badge ' + (cls[key] || '') + '">' + escOtHtml(display) + '</span>';
}
function getCookie(name) {
    var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
}

/* ===== Cancel Order ===== */
var _otCancelData = { orderCode: null, btn: null };

function cancelOtOrder(orderCode, btn, paymentMethod) {
    _otCancelData = { orderCode: orderCode, btn: btn };
    
    // COD - thanh toán khi nhận hàng: hủy bình thường
    if (paymentMethod === 'cod') {
        QHConfirm.show(
            'Bạn có chắc muốn hủy đơn hàng ' + orderCode + '?',
            function() {
                doCancelOtOrder(orderCode, btn);
            }
        );
        return;
    }
    
    // VNPay/VietQR - cần nhập thông tin hoàn tiền
    document.getElementById('otRefundAccount').value = '';
    document.getElementById('otRefundBank').value = '';
    document.getElementById('otRefundModal').classList.add('show');
}

function closeOtRefundModal() {
    document.getElementById('otRefundModal').classList.remove('show');
}

function submitOtRefund() {
    var account = document.getElementById('otRefundAccount').value.trim();
    var bank = document.getElementById('otRefundBank').value.trim();
    
    if (!account) {
        QHToast.show('Vui lòng nhập số tài khoản', 'error');
        return;
    }
    if (!bank) {
        QHToast.show('Vui lòng nhập tên ngân hàng', 'error');
        return;
    }
    
    closeOtRefundModal();
    doCancelOtOrder(_otCancelData.orderCode, _otCancelData.btn, { account: account, bank: bank });
}

function doCancelOtOrder(orderCode, btn, refundInfo) {
    btn.disabled = true;
    btn.innerHTML = '<i class="ri-loader-2-line"></i> Đang hủy...';
    
    var bodyData = { order_code: orderCode };
    if (refundInfo) {
        bodyData.refund_account = refundInfo.account;
        bodyData.refund_bank = refundInfo.bank;
    }
    
    fetch('/api/cancel-order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(bodyData)
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            QHToast.success('Đã hủy đơn hàng và yêu cầu hoàn tiền thành công!');
            location.reload();
        } else {
            QHToast.show(data.message || 'Có lỗi xảy ra', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="ri-close-circle-line"></i> Hủy đơn hàng';
        }
    })
    .catch(function(err) {
        console.error(err);
        QHToast.show('Có lỗi xảy ra khi hủy đơn', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="ri-close-circle-line"></i> Hủy đơn hàng';
    });
}
</script>
{% csrf_token %}
{% endblock %}
