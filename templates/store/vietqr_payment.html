{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Thanh toán VietQR - QHUN22 Mobile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vietqr_payment.css' %}">
{% endblock %}

{% block content %}
<div class="qh-vqr-page">

    <h1 class="qh-page-title">THANH TOÁN CHUYỂN KHOẢN</h1>

    <div class="qh-vqr-wrapper" id="vqrCard">

        <!-- ==================== TRẠNG THÁI ĐANG CHỜ THANH TOÁN ==================== -->
        <div id="vqrPending">

            <!-- Tiêu đề -->
            <div class="qh-vqr-header">
                <div class="qh-vqr-header-left">
                    <i class="ri-qr-code-line"></i>
                    <div>
                        <div class="qh-vqr-header-title">Quét mã QR để thanh toán</div>
                        <div class="qh-vqr-header-sub">Đơn hàng: {{ order.order_code }}</div>
                    </div>
                </div>
                <div class="qh-vqr-timer-badge">
                    <div class="qh-vqr-timer-label">Còn lại</div>
                    <div class="qh-vqr-timer-value" id="vqrTimer">15:00</div>
                </div>
            </div>

            <!-- Mã QR và thông tin thanh toán -->
            <div class="qh-vqr-body">
                <div class="qh-vqr-qr-wrap">
                    <div class="qh-vqr-qr-img">
                        <img id="vqrQrImage" src="" alt="VietQR">
                    </div>
                    <div class="qh-vqr-qr-hint">Dùng app ngân hàng quét mã</div>
                </div>

                <div class="qh-vqr-info">
                    <div class="qh-vqr-info-title">
                        <i class="ri-bank-line"></i> Thông tin chuyển khoản
                    </div>
                    <div class="qh-vqr-row">
                        <span class="lbl">Ngân hàng</span>
                        <span class="val">TECHCOMBANK</span>
                    </div>
                    <div class="qh-vqr-row">
                        <span class="lbl">Chủ tài khoản</span>
                        <span class="val">TRUONG QUANG HUY</span>
                    </div>
                    <div class="qh-vqr-row">
                        <span class="lbl">Số tài khoản</span>
                        <span class="val">22100588888888</span>
                    </div>
                    <div class="qh-vqr-row">
                        <span class="lbl">Số tiền</span>
                        <span class="val amount">{{ order.total_amount|format_price_with_unit }}</span>
                    </div>
                    <div class="qh-vqr-row">
                        <span class="lbl">Nội dung: </span>
                        <span class="val code">{{ transfer_code }}</span>
                    </div>
                </div>
            </div>

            <!-- Chân trang -->
            <div class="qh-vqr-footer">
                <div class="qh-vqr-notice">
                    <i class="ri-error-warning-line"></i>
                    <div>Vui lòng chuyển khoản <strong>đúng số tiền</strong> và <strong>đúng nội dung</strong>. Sau khi chuyển, hệ thống sẽ xác nhận.</div>
                </div>
                <div class="qh-vqr-status" id="vqrStatusBox">
                    <i class="ri-refresh-line"></i>
                    <span>Chờ xác nhận</span>
                    <div class="dot-pulse">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>

        </div>
        <!-- Kết thúc trạng thái đang chờ -->

        <!-- ==================== TRẠNG THÁI HẾT HẠN ==================== -->
        <div class="qh-vqr-expired" id="vqrExpired">
            <div class="qh-vqr-expired-hero">
                <div class="qh-vqr-expired-icon">
                    <i class="ri-time-line"></i>
                </div>
                <h2>HẾT THỜI GIAN THANH TOÁN</h2>
                <p>Phiên thanh toán đã hết hạn (15 phút).<br>Đơn hàng đã bị huỷ. Vui lòng quay lại giỏ hàng và thử lại.</p>
            </div>
            <div class="qh-vqr-expired-actions">
                <a href="{% url 'store:cart_detail' %}" class="qh-vqr-btn primary">
                    <i class="ri-shopping-cart-line"></i> Quay lại giỏ hàng
                </a>
                <a href="{% url 'store:home' %}" class="qh-vqr-btn">
                    <i class="ri-home-line"></i> Về trang chủ
                </a>
            </div>
        </div>
        <!-- Kết thúc trạng thái hết hạn -->

    </div>
    <!-- Kết thúc thẻ QR -->

</div>
{% endblock %}

{% block extra_js %}
<!-- JavaScript thanh toán VietQR -->
<script>
(function() {
    // ==================== CONFIGURATION ====================
    var BANK_ID = 'TCB';
    var ACCOUNT_NO = '22100588888888';
    var ACCOUNT_NAME = 'TRUONG QUANG HUY';
    var TIMEOUT_SECONDS = {{ timeout_seconds }};
    var TRANSFER_CODE = '{{ transfer_code }}';
    var ORDER_CODE = '{{ order.order_code }}';
    var STATUS_URL = '{% url "store:vietqr_page_status" %}';
    var EXPIRE_URL = '{% url "store:vietqr_expire" %}';
    var SUCCESS_URL = '{% url "store:order_success" order_code=order.order_code %}';
    var CSRF_TOKEN = '{{ csrf_token }}';
    var TOTAL_AMOUNT = {{ order.total_amount }};

    // ==================== DOM ELEMENTS ====================
    var timerEl = document.getElementById('vqrTimer');
    var pendingEl = document.getElementById('vqrPending');
    var expiredEl = document.getElementById('vqrExpired');
    var qrImgEl = document.getElementById('vqrQrImage');

    // ==================== STATE ====================
    var timerInterval = null;
    var pollInterval = null;
    var remaining = TIMEOUT_SECONDS;

    // ==================== QR URL BUILDER ====================
    /**
     * Build VietQR URL with payment details
     * @returns {string} QR image URL
     */
    function buildQrUrl() {
        return 'https://img.vietqr.io/image/' + BANK_ID + '-' + ACCOUNT_NO + '-vietqr_net_2.jpg'
            + '?amount=' + TOTAL_AMOUNT
            + '&addInfo=' + encodeURIComponent(TRANSFER_CODE)
            + '&accountName=' + encodeURIComponent(ACCOUNT_NAME);
    }

    // ==================== TIMER FUNCTIONS ====================
    /**
     * Format seconds to MM:SS
     * @param {number} sec - Seconds to format
     * @returns {string} Formatted time string
     */
    function formatTimer(sec) {
        var m = Math.floor(sec / 60);
        var s = sec % 60;
        return (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
    }

    /**
     * Start countdown timer
     */
    function startTimer() {
        timerEl.textContent = formatTimer(remaining);

        timerInterval = setInterval(function() {
            remaining--;
            if (remaining <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                onExpired();
                return;
            }
            timerEl.textContent = formatTimer(remaining);
            if (remaining <= 120) {
                timerEl.classList.add('warning');
            }
        }, 1000);
    }

    // ==================== POLLING FUNCTIONS ====================
    /**
     * Start polling for payment status
     */
    function startPolling() {
        pollInterval = setInterval(function() {
            fetch(STATUS_URL + '?code=' + encodeURIComponent(TRANSFER_CODE) + '&order_code=' + encodeURIComponent(ORDER_CODE))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (!data.success) return;
                    if (data.status === 'approved') {
                        onSuccess();
                    } else if (data.status === 'cancelled' || data.status === 'expired') {
                        onExpired();
                    }
                })
                .catch(function() {});
        }, 3000);
    }

    // ==================== HELPER FUNCTIONS ====================
    /**
     * Stop all intervals
     */
    function stopAll() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }

    // ==================== EVENT HANDLERS ====================
    /**
     * Handle successful payment
     */
    function onSuccess() {
        stopAll();
        if (window.QHToast) {
            QHToast.show('Thanh toán thành công!', 'success');
        }
        window.location.href = SUCCESS_URL;
    }

    /**
     * Handle expired payment
     */
    function onExpired() {
        stopAll();

        // Call expire API
        fetch(EXPIRE_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify({
                order_code: ORDER_CODE,
                transfer_code: TRANSFER_CODE
            })
        }).catch(function() {});

        // Show expired state
        pendingEl.style.display = 'none';
        expiredEl.style.display = 'block';

        if (window.QHToast) {
            QHToast.show('Hết thời gian thanh toán. Đơn hàng đã bị huỷ.', 'error');
        }
    }

    /**
     * Load QR code image
     */
    function loadQR() {
        if (qrImgEl) {
            qrImgEl.src = buildQrUrl();
        }
    }

    // ==================== INITIALIZATION ====================
    // Load QR code
    loadQR();

    // Start timer and polling if not expired
    if (remaining > 0) {
        startTimer();
        startPolling();
    } else {
        onExpired();
    }
})();
</script>
{% endblock %}
