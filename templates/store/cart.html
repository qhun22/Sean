{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}GIỎ HÀNG - QHUN22 Mobile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<div class="qh-cart-page">
    <h1 class="qh-page-title">GIỎ HÀNG CỦA BẠN</h1>

    {% if cart_items %}
    <div class="qh-cart-container">
        <!-- Left: Cart Items -->
        <div class="qh-cart-list">
            <!-- Select All Header -->
            <div class="qh-cart-select-all">
                <label>
                    <input type="checkbox" class="qh-cart-checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    Chọn tất cả (<span id="selectedCount">0</span>)
                </label>
                <button class="qh-cart-delete-all" onclick="deleteSelected()" title="Xóa các sản phẩm đã chọn">
                    <svg style="width:20px;height:20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>

            <!-- Cart Item Cards -->
            {% for item in cart_items %}
            <div class="qh-cart-item" data-item-id="{{ item.id }}">
                <!-- Checkbox -->
                <div class="qh-cart-item-check">
                    <input type="checkbox" class="qh-cart-checkbox cart-item-check" data-item-id="{{ item.id }}" onchange="updateSelectedCount()">
                </div>

                <!-- Image -->
                <div class="qh-cart-item-img">
                    {% if item.color_thumbnail %}
                    <a href="{% url 'store:product_detail' item.product.id %}">
                        <img src="{{ item.color_thumbnail }}" alt="{{ item.product.name }}" id="itemImg_{{ item.id }}">
                    </a>
                    {% elif item.product.image %}
                    <a href="{% url 'store:product_detail' item.product.id %}">
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" id="itemImg_{{ item.id }}">
                    </a>
                    {% else %}
                    <div class="qh-cart-no-img">
                        <svg style="width:40px;height:40px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    {% endif %}
                </div>

                <!-- Details -->
                <div class="qh-cart-item-details">
                    <a href="{% url 'store:product_detail' item.product.id %}" class="qh-cart-item-name">
                        {{ item.product.name }}
                    </a>

                    <!-- Color Dropdown -->
                    {% if item.color_name %}
                    <div class="qh-cart-color-dropdown" data-item-id="{{ item.id }}">
                        <div class="qh-cart-color-selected" onclick="toggleColorDropdown(this)">
                            <span>Màu: {{ item.color_name|color_only }}</span>
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                        <!-- Color Options (inside the dropdown so toggle controls both) -->
                        {% if item.color_options %}
                        <div class="qh-cart-color-options" id="colorOptions_{{ item.id }}">
                            {% for opt in item.color_options %}
                            <button class="qh-cart-color-opt{% if opt.is_selected %} selected{% endif %}"
                                    data-item-id="{{ item.id }}"
                                    data-color="{{ opt.color_name }}"
                                    data-thumbnail="{{ opt.thumbnail }}"
                                    onclick="changeColor(this, {{ item.id }}, '{{ opt.color_name }}')">
                                {% if opt.thumbnail %}
                                <img src="{{ opt.thumbnail }}" alt="{{ opt.color_name|color_only }}">
                                {% endif %}
                                <span>{{ opt.color_name|color_only }}</span>
                            </button>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Storage Dropdown -->
                    {% if item.storage %}
                    <div class="qh-cart-storage-dropdown" data-item-id="{{ item.id }}">
                        <div class="qh-cart-storage-selected" onclick="toggleStorageDropdown(this)">
                            <span>Dung lượng: {{ item.storage }}</span>
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                        <!-- Storage Options (inside the dropdown) -->
                        {% if item.storage_options and item.storage_options|length > 1 %}
                        <div class="qh-cart-storage-options" id="storageOptions_{{ item.id }}">
                            {% for opt in item.storage_options %}
                            <button class="qh-cart-storage-opt{% if opt.is_selected %} selected{% endif %}"
                                    data-item-id="{{ item.id }}"
                                    data-storage="{{ opt.storage }}"
                                    onclick="changeStorage(this, {{ item.id }}, '{{ opt.storage }}')">
                                {{ opt.storage }}
                            </button>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Right: Price + Quantity + Delete -->
                <div class="qh-cart-item-right">
                    <div class="qh-cart-item-price">
                        <div class="qh-cart-item-current-price" id="itemPrice_{{ item.id }}">
                            {{ item.price_at_add|format_price_with_unit }}
                        </div>
                        {% if item.original_price %}
                        <div class="qh-cart-item-original-price" id="itemOrigPrice_{{ item.id }}">
                            {{ item.original_price|format_price_with_unit }}
                        </div>
                        {% else %}
                        <div class="qh-cart-item-original-price" id="itemOrigPrice_{{ item.id }}" style="display:none;"></div>
                        {% endif %}
                    </div>

                    <div class="qh-cart-item-actions">
                        <div class="qh-cart-qty">
                            <button class="qh-cart-qty-btn qh-cart-qty-minus" data-item-id="{{ item.id }}" {% if item.quantity <= 1 %}disabled{% endif %} onclick="updateCartQuantity({{ item.id }}, parseInt(document.getElementById('qtyInput_{{ item.id }}').value) - 1)">−</button>
                            <input type="number" class="qh-cart-qty-input" id="qtyInput_{{ item.id }}" value="{{ item.quantity }}" min="1" onchange="updateCartQuantity({{ item.id }}, this.value)">
                            <button class="qh-cart-qty-btn" onclick="updateCartQuantity({{ item.id }}, parseInt(document.getElementById('qtyInput_{{ item.id }}').value) + 1)">+</button>
                        </div>
                        <button class="qh-cart-delete-btn" onclick="removeFromCart({{ item.id }})" title="Xóa sản phẩm">
                            <svg style="width:20px;height:20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Right: Cart Summary -->
        <div class="qh-cart-summary">
            <h2 class="qh-cart-summary-title">Thông tin đang chọn</h2>

            <!-- Danh sách tên sản phẩm đã chọn -->
            <div id="summaryProductList" style="margin-bottom: 16px; font-size: 14px; color: #64748b;">
                <p style="color: #94a3b8; font-style: italic;">Chưa chọn sản phẩm nào</p>
            </div>

            <div class="qh-cart-summary-row total" style="margin-top: 0;">
                <span>Tạm tính</span>
                <span class="qh-cart-value" id="summaryTotal">0 đ</span>
            </div>

            <button class="qh-cart-checkout-btn" onclick="checkout()">
                XÁC NHẬN
            </button>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="qh-card" style="padding: 60px; text-align: center;">
        <svg class="qh-empty-cart-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        <h3 style="color: var(--qh-text); margin-bottom: 12px; font-size: 24px; font-weight: 600;">GIỎ HÀNG TRỐNG</h3>
        <p style="color: var(--qh-text-light); margin-bottom: 24px; font-size: 16px;">Hãy thêm sản phẩm để kiểm tra tại đây nhé!</p>
        <a href="{% url 'store:home' %}" class="qh-btn qh-btn-primary" style="padding: 12px 32px; font-size: 16px; font-weight: 600;">
            Tiếp tục khám phá
        </a>
    </div>
    {% endif %}
</div>

{% block extra_js %}
<script src="{% static 'js/cart.js' %}"></script>
{% endblock %}
{% endblock %}
