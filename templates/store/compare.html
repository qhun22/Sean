{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}So sánh sản phẩm - QHUN22 Mobile{% endblock %}

{% block content %}
{# CSS có sử dụng Django template tag {{ products|length }} nên giữ lại phần grid-template-columns #}
<style>
/* Grid columns cần giữ lại do sử dụng Django template tag */
.qh-compare-grid {
    display: grid;
    grid-template-columns: repeat({{ products|length }}, 1fr);
}
</style>
<link rel="stylesheet" href="{% static 'css/compare.css' %}">

<!-- Header -->
<div class="qh-compare-header">
    <h1>SO SÁNH SẢN PHẨM ({{ products|length }})</h1>
</div>

<!-- Filter -->
<div class="qh-compare-filter">
    <label for="qh-compare-filter-select"><i class="ri-filter-3-line"></i> Lọc thông số:</label>
    <select id="qh-compare-filter-select" onchange="filterSpecs(this.value)">
        <option value="all">Tất cả</option>
        <option value="same">Chỉ giống nhau</option>
        <option value="diff">Chỉ khác nhau</option>
    </select>
</div>

<!-- Product Columns -->
<div class="qh-compare-grid">
    {% for item in compare_data %}
    <div class="qh-compare-col">
        <!-- Product Header -->
        <div class="qh-compare-col-header">
            <button class="qh-compare-col-remove" onclick="removeAndReload({{ item.product.id }})" title="Xóa khỏi so sánh">
                <i class="ri-close-line"></i>
            </button>
            {% if item.product.image %}
            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="qh-compare-col-img">
            {% else %}
            <div class="qh-compare-col-img-empty">
                <i class="ri-image-line" style="font-size:32px;"></i>
            </div>
            {% endif %}
            <div class="qh-compare-col-name">{{ item.product.name }}</div>
            {% if item.product.detail and item.product.detail.summary_original_price and item.product.detail.summary_original_price > item.product.detail.discounted_price and item.product.detail.summary_discount_percent > 0 %}
            <div class="qh-compare-col-oldprice">{{ item.product.detail.summary_original_price|format_price_with_unit }}</div>
            {% endif %}
            <div class="qh-compare-col-price">
                {% if item.product.detail %}{{ item.product.detail.discounted_price|format_price_with_unit }}{% else %}{{ item.product.price|format_price_with_unit }}{% endif %}
            </div>
        </div>

        <!-- Spec Groups -->
        {% for group in item.groups %}
        <div class="qh-compare-spec-group">
            <div class="qh-compare-spec-group-title">{{ group.title }}</div>
            <table>
                {% for spec in group.items %}
                <tr class="qh-spec-row" data-label="{{ spec.label }}">
                    <td>{{ spec.label }}</td>
                    <td class="qh-spec-val">{{ spec.value }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% empty %}
        <div class="qh-compare-col-empty">
            <i class="ri-information-line" style="font-size:24px;display:block;margin-bottom:8px;color:#ccc;"></i>
            Chưa có thông số kỹ thuật
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
{# JS thuần - đã tách ra file static/js/compare.js #}
<script src="{% static 'js/compare.js' %}"></script>
{% endblock %}
