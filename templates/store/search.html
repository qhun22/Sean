{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}TÌM KIẾM - QHUN22 Mobile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/search.css' %}">
{% endblock %}

{% block content %}
<div class="qh-search-page">
    <h1 class="qh-page-title">Tìm kiếm sản phẩm</h1>

    {% if query or brand %}
    <div class="qh-search-info">
        {% if current_brand %}
        <h2>Kết quả cho hãng: <span class="qh-brand-badge">{{ current_brand.name }}</span></h2>
        <p>Tìm thấy <strong>{{ products.paginator.count }}</strong> sản phẩm</p>
        {% elif query %}
        <h2>Kết quả tìm kiếm cho: "<strong>{{ query }}</strong>"</h2>
        <p>Tìm thấy <strong>{{ products.paginator.count }}</strong> sản phẩm</p>
        {% endif %}
    </div>
    {% endif %}

    {% if products %}
    <!-- Product Grid: 5 products per row -->
    <div class="qh-product-grid">
        {% for product in products %}
        <a href="{% url 'store:product_detail' product.id %}" class="qh-product-card {% if product.stock == 0 %}out-of-stock{% endif %}">

            <!-- Product Image -->
            <div class="qh-product-image">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                <div class="qh-product-placeholder">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
                {% endif %}

                <!-- Discount Badge -->
                {% if product.detail and product.detail.summary_original_price and product.detail.summary_original_price > product.detail.discounted_price and product.detail.summary_discount_percent > 0 %}
                <div class="discount-badge">
                    -{{ product.detail.summary_discount_percent }}%
                </div>
                {% endif %}

                <!-- Wishlist Heart Button -->
                {% if product.id in wishlist_product_ids %}
                <button class="wishlist-btn liked" data-product-id="{{ product.id }}" onclick="toggleWishlist(this, {{ product.id }}); return false;">
                {% else %}
                <button class="wishlist-btn" data-product-id="{{ product.id }}" onclick="toggleWishlist(this, {{ product.id }}); return false;">
                {% endif %}
                    <svg viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                </button>

                <!-- Out of Stock Overlay -->
                {% if product.stock == 0 %}
                <div class="out-of-stock-overlay"></div>
                {% endif %}
            </div>

            <!-- Product Info -->
            <div class="qh-product-info">
                <!-- Product Name -->
                <h3 class="qh-product-name">
                    {{ product.name }}
                </h3>

                <!-- Price -->
                <div class="qh-product-price">
                    {% if product.detail and product.detail.summary_original_price and product.detail.summary_original_price > product.detail.discounted_price and product.detail.summary_discount_percent > 0 %}
                    <span class="original-price">
                        {{ product.detail.summary_original_price|format_price_with_unit }}
                    </span>
                    <span class="discounted-price">
                        {{ product.detail.discounted_price|format_price_with_unit }}
                    </span>
                    {% else %}
                    <span class="regular-price">
                        {% if product.detail %}{{ product.detail.discounted_price|format_price_with_unit }}{% else %}{{ product.price|format_price_with_unit }}{% endif %}
                    </span>
                    {% endif %}
                </div>

                <!-- Status Row -->
                <div class="qh-product-status">
                    {% if product.stock > 0 %}
                    <span class="status-tag in-stock">Còn hàng</span>
                    <span class="status-tag installment">Trả góp 0%</span>
                    {% else %}
                    <span class="status-tag out-of-stock">Hết hàng</span>
                    {% endif %}
                </div>

                <!-- Action Buttons -->
                <button class="qh-btn qh-btn-outline qh-compare-btn"
                        data-product-id="{{ product.id }}"
                        data-product-name="{{ product.name }}"
                        data-product-image="{% if product.image %}{{ product.image.url }}{% else %}{% endif %}"
                        data-product-price="{% if product.detail %}{{ product.detail.discounted_price|format_price_with_unit }}{% else %}{{ product.price|format_price_with_unit }}{% endif %}"
                        onclick="event.preventDefault();event.stopPropagation();QHCompare.addToCompare({{ product.id }}, this.dataset.productName, this.dataset.productImage, this.dataset.productPrice)">
                    <i class="ri-arrow-left-right-line"></i> So sánh
                </button>
            </div>
        </a>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if products.has_other_pages %}
    <div class="qh-pagination">
        {% if products.has_previous %}
        <a href="?{% if query %}q={{ query }}&{% endif %}{% if brand %}brand={{ brand }}&{% endif %}page={{ products.previous_page_number }}" class="qh-btn qh-btn-secondary">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        {% endif %}

        {% for num in products.paginator.page_range %}
            {% if products.number == num %}
            <span class="qh-btn qh-btn-primary current">{{ num }}</span>
            {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
            <a href="?{% if query %}q={{ query }}&{% endif %}{% if brand %}brand={{ brand }}&{% endif %}page={{ num }}" class="qh-btn qh-btn-secondary">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if products.has_next %}
        <a href="?{% if query %}q={{ query }}&{% endif %}{% if brand %}brand={{ brand }}&{% endif %}page={{ products.next_page_number }}" class="qh-btn qh-btn-secondary">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <!-- No Results -->
    <div class="qh-no-results">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            <line x1="8" y1="11" x2="14" y2="11"></line>
        </svg>
        <h3>Không tìm thấy sản phẩm nào</h3>
        <p>
            {% if query %}
            Không có sản phẩm nào phù hợp với từ khóa "<strong>{{ query }}</strong>"
            {% elif brand %}
            Không có sản phẩm nào của hãng này
            {% else %}
            Vui lòng nhập từ khóa tìm kiếm hoặc chọn hãng
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

<!-- Wishlist Toggle JavaScript -->
{# ========================================================================= #}
{# NOTE: JS KHÔNG THỂ TÁCH RA FILE RIÊNG vì sử dụng Django template tags #}
{# - {% url "store:wishlist_toggle" %} - URL từ Django #}
{# - {{ csrf_token }} - Token từ Django #}
{# - {% url "store:login" %} - URL từ Django #}
{# Nếu tách ra file .js thuần, các template tags này sẽ không được xử lý #}
{# ========================================================================= #}
<script>
/**
 * Update wishlist badge count in header
 * @param {number} count - New wishlist count
 */
function updateWishlistBadge(count) {
    var badge = document.getElementById('qh-wishlist-count');
    if (badge) {
        badge.textContent = count;
    }
}

/**
 * Toggle wishlist status for a product
 * @param {HTMLElement} button - Wishlist button element
 * @param {number} productId - Product ID
 */
function toggleWishlist(button, productId) {
    // Send AJAX request to toggle wishlist
    fetch('{% url "store:wishlist_toggle" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'product_id=' + productId
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            // Toggle class liked
            if (data.is_liked) {
                button.classList.add('liked');
            } else {
                button.classList.remove('liked');
            }
            // Update wishlist count in header
            updateWishlistBadge(data.total_wishlist);
            // Show toast notification
            if (data.is_liked) {
                QHToast.show('Đã thêm vào danh sách yêu thích', 'success');
            } else {
                QHToast.show('Đã xóa khỏi danh sách yêu thích', 'success');
            }
        } else {
            // Handle not logged in
            if (data.message && data.message.includes('đăng nhập')) {
                if (confirm(data.message)) {
                    window.location.href = '{% url "store:login" %}';
                }
            } else {
                QHToast.show(data.message || 'Có lỗi xảy ra', 'error');
            }
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        QHToast.show('Có lỗi xảy ra', 'error');
    });
}
</script>
{% endblock %}
