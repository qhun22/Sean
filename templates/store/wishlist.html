{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}YÊU THÍCH - QHUN22 Mobile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/wishlist.css' %}">
{% endblock %}

{% block content %}

<div class="qh-wishlist-page">
    <h1 class="qh-page-title">YÊU THÍCH CỦA BẠN</h1>

    {% if products %}
    <!-- Lưới sản phẩm: 5 sản phẩm mỗi hàng -->
    <div class="qh-product-grid">
        {% for product in products %}
        <a href="{% url 'store:product_detail' product.id %}" class="qh-product-card {% if product.stock == 0 %}out-of-stock{% endif %}">

            <!-- Ảnh sản phẩm -->
            <div class="qh-product-image">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
                {% else %}
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--qh-text-light);">
                    <svg style="width: 64px; height: 64px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
                {% endif %}

                <!-- Huy hiệu giảm giá -->
                {% if product.detail and product.detail.summary_original_price and product.detail.summary_original_price > product.detail.discounted_price and product.detail.summary_discount_percent > 0 %}
                <div class="discount-badge">
                    -{{ product.detail.summary_discount_percent }}%
                </div>
                {% endif %}

                <!-- Nút tim danh sách yêu thích -->
                <button class="wishlist-btn liked" data-product-id="{{ product.id }}" onclick="toggleWishlist(event, this, {{ product.id }}); return false;">
                    <svg viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                </button>

                <!-- Lớp phủ hết hàng -->
                {% if product.stock == 0 %}
                <div class="out-of-stock-overlay"></div>
                {% endif %}
            </div>

            <!-- Thông tin sản phẩm -->
            <div class="qh-product-info">
                <!-- Tên sản phẩm -->
                <h3 class="qh-product-name">
                    {{ product.name }}
                </h3>

                <!-- Giá -->
                <div class="qh-product-price">
                    {% if product.detail and product.detail.summary_original_price and product.detail.summary_original_price > product.detail.discounted_price and product.detail.summary_discount_percent > 0 %}
                    <span class="original-price">
                        {{ product.detail.summary_original_price|format_price_with_unit }}
                    </span>
                    <span class="discounted-price">
                        {{ product.detail.discounted_price|format_price_with_unit }}
                    </span>
                    {% else %}
                    <span class="regular-price">
                        {% if product.detail %}{{ product.detail.discounted_price|format_price_with_unit }}{% else %}{{ product.price|format_price_with_unit }}{% endif %}
                    </span>
                    {% endif %}
                </div>

                <!-- Hàng hiển thị trạng thái sản phẩm -->
                <div class="qh-product-status">
                    {% if product.stock > 0 %}
                    <span class="status-tag in-stock">Còn hàng</span>
                    <span class="status-tag installment">Trả góp 0%</span>
                    {% else %}
                    <span class="status-tag out-of-stock">Hết hàng</span>
                    {% endif %}
                </div>

                <!-- Các nút hành động -->
                <div style="display: flex; gap: 6px;">
                    <button class="qh-btn qh-btn-outline qh-compare-btn"
                            data-product-id="{{ product.id }}"
                            data-product-name="{{ product.name }}"
                            data-product-image="{% if product.image %}{{ product.image.url }}{% else %}{% endif %}"
                            data-product-price="{% if product.detail %}{{ product.detail.discounted_price|format_price_with_unit }}{% else %}{{ product.price|format_price_with_unit }}{% endif %}"
                            onclick="event.preventDefault();event.stopPropagation();QHCompare.addToCompare({{ product.id }}, this.dataset.productName, this.dataset.productImage, this.dataset.productPrice)">
                        <i class="ri-arrow-left-right-line"></i> So sánh
                    </button>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>

    <!-- Phân trang -->
    {% if products.has_other_pages %}
    <div class="qh-pagination">
        {% if products.has_previous %}
        <a href="?page={{ products.previous_page_number }}" class="qh-btn qh-btn-secondary" style="padding: 8px 16px;">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        {% endif %}

        {% for num in products.paginator.page_range %}
            {% if products.number == num %}
            <span class="qh-btn qh-btn-primary" style="padding: 8px 16px; cursor: default;">{{ num }}</span>
            {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
            <a href="?page={{ num }}" class="qh-btn qh-btn-secondary" style="padding: 8px 16px;">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if products.has_next %}
        <a href="?page={{ products.next_page_number }}" class="qh-btn qh-btn-secondary" style="padding: 8px 16px;">
            <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <!-- Trạng thái danh sách rỗng -->
    <div class="qh-card">
        <svg class="qh-empty-heart" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
        <h3>YÊU THÍCH TRỐNG</h3>
        <p>Hãy thêm sản phẩm bạn yêu thích để kiểm tra tại đây nhé!</p>
        <a href="{% url 'store:home' %}" class="qh-btn qh-btn-primary" style="padding: 12px 32px; font-size: 16px; font-weight: 600;">
            Tiếp tục khám phá
        </a>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<!-- JavaScript điều khiển Wishlist -->
<script>
function updateWishlistBadge(count) {
    var badge = document.getElementById('qh-wishlist-count');
    if (badge) {
        badge.textContent = count;
    }
}

function toggleWishlist(event, button, productId) {
    // Prevent navigation to product detail
    event.preventDefault();
    event.stopPropagation();

    fetch('{% url "store:wishlist_toggle" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'product_id=' + productId
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            // Toggle class liked
            if (data.is_liked) {
                button.classList.add('liked');
            } else {
                button.classList.remove('liked');
            }
            // Update wishlist count in header
            updateWishlistBadge(data.total_wishlist);
            // Show toast notification
            if (window.QHToast) {
                QHToast.show(data.message, 'success');
            }
            // If on wishlist page and unliked, reload to update list
            {% if request.resolver_match.url_name == 'wishlist' %}
            if (!data.is_liked) {
                setTimeout(function() {
                    location.reload();
                }, 500);
            }
            {% endif %}
        } else if (data.require_login) {
            if (window.QHConfirm) {
                QHConfirm.show(data.message + '. Bạn có muốn đăng nhập không?', function() {
                    window.location.href = '{% url "store:login" %}';
                });
            } else {
                if (confirm(data.message + '. Bạn có muốn đăng nhập không?')) {
                    window.location.href = '{% url "store:login" %}';
                }
            }
        } else {
            if (window.QHToast) {
                QHToast.show(data.message, 'error');
            } else {
                alert(data.message);
            }
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        if (window.QHToast) {
            QHToast.show('Có lỗi xảy ra. Vui lòng thử lại.', 'error');
        } else {
            alert('Có lỗi xảy ra. Vui lòng thử lại.');
        }
    });
}
</script>
{% endblock %}
