{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}{{ product.name }} - QHUN22 Mobile{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/product_detail.css' %}">

<div class="pd-page">
    <!-- Breadcrumb -->
    <div class="pd-breadcrumb">
        <a href="/">Trang chủ</a> <span>›</span>
        <a href="/">Điện thoại</a> <span>›</span>
        {% if product.brand %}<a href="/">{{ product.brand.name }}</a> <span>›</span>{% endif %}
        <span class="current">{{ product.name }}</span>
    </div>

    <!-- Product Name -->
    <h1 class="pd-product-name">{{ product.name }}</h1>

    <div class="pd-grid">
        <!-- ===== LEFT: Images ===== -->
        <div class="pd-images">
            <div class="pd-main-image"
                 onmouseenter="pauseAutoSlide()"
                 onmouseleave="resumeAutoSlide()">
                <button class="pd-img-nav prev" onclick="prevImage()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <img id="pdMainImg" src="{{ product.image.url|default:'/static/logos/sean.gif' }}" alt="{{ product.name }}" data-fallback="{{ product.image.url|default:'/static/logos/sean.gif' }}">
                <button class="pd-img-nav next" onclick="nextImage()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </button>
            </div>

            <!-- Bottom tabs (mini thumbnails + spec/info/gallery) -->
            <div class="pd-bottom-tabs" id="pdBottomTabs"></div>
        </div>

        <!-- ===== RIGHT: Info ===== -->
        <div class="pd-info">
            <!-- Price -->
            <div class="pd-price-section">
                <span class="pd-price-current" id="pdPrice">
                    {% if first_variant %}{{ first_variant.price|format_price }} đ{% else %}Liên hệ{% endif %}
                </span>
                <span class="pd-price-original" id="pdOriginalPrice">
                    {% if first_variant and first_variant.original_price > first_variant.price %}{{ first_variant.original_price|format_price }} đ{% endif %}
                </span>
                <span class="pd-sku-inline">SKU: <strong id="pdSku">{{ first_variant.sku|default:'-' }}</strong></span>
            </div>

            <!-- Installment -->
            <div class="pd-installment" id="pdInstallment"></div>

            <!-- Storage Selection -->
            <div class="pd-variant-section">
                <div class="pd-variant-label">Lựa chọn dung lượng</div>
                <div class="pd-storage-options" id="pdStorageOptions">
                    {% for storage in storage_list %}
                    <button class="pd-storage-btn{% if forloop.first %} selected{% endif %}" data-storage="{{ storage }}" onclick="selectStorage(this)">
                        <div class="pd-storage-name">{{ storage }}</div>
                        <div class="pd-storage-price" id="storagePrice_{{ forloop.counter }}"></div>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Color Selection -->
            <div class="pd-variant-section">
                <div class="pd-variant-label">Lựa chọn màu</div>
                <div class="pd-color-options" id="pdColorOptions">
                    {% for c in color_list %}
                    <button class="pd-color-btn{% if forloop.first %} selected{% endif %}" data-color="{{ c.color_name }}" data-sku="{{ c.sku }}" onclick="selectColor(this)">
                        <div class="pd-color-thumb" id="colorThumb_{{ forloop.counter0 }}"></div>
                        <div class="pd-color-info">
                            <div class="pd-color-name">{{ c.color_name }}</div>
                        </div>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Buy Section -->
            <div class="pd-buy-section">
                <button class="pd-btn-cart" onclick="addToCart()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z"/></svg>
                    Thêm vào giỏ hàng
                </button>
                <button class="pd-btn-buy" onclick="buyNow()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                    Mua ngay
                </button>
            </div>

            <!-- Promo Banner -->
            {% if promo_banner %}
            <div class="pd-promo-banner">
                <div class="pd-promo-banner-img">
                    <img src="{{ promo_banner.image.url }}" alt="Ưu đãi học sinh sinh viên">
                </div>
                <a href="#" class="pd-promo-banner-btn">
                    Xác thực ngay
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Product Description Section -->
    <div class="pd-spec-section" id="pdDescSection" style="display: none;">
        <h2 class="pd-spec-title">Thông tin sản phẩm</h2>
        <div id="pdDescContent" style="font-size: 14px; color: #334155; line-height: 1.7; white-space: pre-line;"></div>
    </div>

    <!-- Video về sản phẩm & Cam kết sản phẩm -->
    {% if youtube_id %}
    <div class="pd-extra-row">
        <!-- Box Video YouTube -->
        <div class="pd-extra-box">
            <h2 class="pd-extra-title">
                <svg width="22" height="22" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Video về sản phẩm
            </h2>
            <div class="pd-video-wrapper">
                <div id="pdYoutubePlayer"></div>
            </div>
        </div>
        <!-- Box Cam kết sản phẩm -->
        <div class="pd-extra-box">
            <h2 class="pd-extra-title">
                <svg width="22" height="22" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                Cam kết sản phẩm
            </h2>
            <div class="pd-commit-content">
                <ul class="pd-commit-list">
                    <li>
                        <span class="pd-commit-icon"><i class="ri-truck-line"></i></span>
                        <span>Miễn phí vận chuyển toàn quốc – Giao hỏa tốc 2H nội thành</span>
                    </li>
                    <li>
                        <span class="pd-commit-icon"><i class="ri-shield-check-line"></i></span>
                        <span>Bảo hành chính hãng Apple 12 tháng toàn quốc</span>
                    </li>
                    <li>
                        <span class="pd-commit-icon"><i class="ri-box-3-line"></i></span>
                        <span>Máy mới 100% nguyên Seal – Chưa Active – Lỗi đổi mới trong 12 tháng</span>
                    </li>
                    <li>
                        <span class="pd-commit-icon"><i class="ri-file-list-3-line"></i></span>
                        <span>Giá đã bao gồm VAT – Xuất hóa đơn đầy đủ</span>
                    </li>
                    <li>
                        <span class="pd-commit-icon"><i class="ri-search-eye-line"></i></span>
                        <span>Hỗ trợ kiểm tra IMEI/Serial chính hãng trước khi nhận hàng</span>
                    </li>
                    <li>
                        <span class="pd-commit-icon"><i class="ri-bank-card-line"></i></span>
                        <span>Hỗ trợ trả góp 0% – Thu cũ đổi mới giá cao</span>
                    </li>
                    <li>
                        <span class="pd-commit-icon"><i class="ri-checkbox-circle-line"></i></span>
                        <span>Kiểm tra hàng trước khi thanh toán – Hỗ trợ kỹ thuật trọn đời</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ===== Đánh giá sản phẩm ===== -->
    <div class="pd-extra-box pd-review-section" style="margin-top: 32px;">
        <h2 class="pd-extra-title">
            <svg width="22" height="22" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
            Đánh giá sản phẩm
            {% if review_count > 0 %}
            <span class="pd-review-summary">{{ avg_rating }}/5 ({{ review_count }} đánh giá)</span>
            {% endif %}
        </h2>

        <div class="pd-review-body">
            <!-- Trung bình sao -->
            {% if review_count > 0 %}
            <div class="pd-review-avg">
                <div class="pd-review-avg-stars">
                    {% for i in "12345" %}
                    <svg class="pd-star {% if forloop.counter <= avg_rating %}filled{% endif %}" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                    {% endfor %}
                </div>
                <span class="pd-review-avg-text">{{ avg_rating }} / 5</span>
                <span class="pd-review-avg-count">({{ review_count }} đánh giá)</span>
            </div>
            {% endif %}

            <!-- Form đánh giá -->
            <div class="pd-review-form-area" id="pdReviewForm">
                {% if must_login %}
                <div class="pd-review-login-msg">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    Vui lòng <a href="{% url 'store:login' %}">đăng nhập</a> để đánh giá sản phẩm.
                </div>
                {% elif user_review %}
                <div class="pd-review-done-msg">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Bạn đã đánh giá sản phẩm này <strong>{{ user_review.rating }} sao</strong>.
                    <div class="pd-review-done-stars">
                        {% for i in "12345" %}
                        <svg class="pd-star {% if forloop.counter <= user_review.rating %}filled{% endif %}" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                        {% endfor %}
                    </div>
                </div>
                {% elif can_review %}
                <div class="pd-review-input">
                    <p class="pd-review-label">Chọn số sao để đánh giá:</p>
                    <div class="pd-review-stars" id="pdReviewStars">
                        {% for i in "12345" %}
                        <svg class="pd-star-btn" data-value="{{ forloop.counter }}" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                        {% endfor %}
                    </div>
                    <button class="pd-review-submit" id="pdReviewSubmitBtn" disabled>Gửi đánh giá</button>
                    <div class="pd-review-msg" id="pdReviewMsg"></div>
                </div>
                {% else %}
                <div class="pd-review-login-msg">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Bạn cần mua và nhận hàng thành công để đánh giá sản phẩm này.
                </div>
                {% endif %}
            </div>

            <!-- Danh sách đánh giá -->
            {% if reviews %}
            <div class="pd-review-list">
                {% for r in reviews %}
                <div class="pd-review-item">
                    <div class="pd-review-user">
                        <div class="pd-review-avatar">{{ r.user.get_short_name|first }}</div>
                        <div class="pd-review-user-info">
                            <span class="pd-review-name">{{ r.user.get_full_name }}</span>
                            <span class="pd-review-date">{{ r.created_at|date:"d/m/Y H:i" }}</span>
                        </div>
                    </div>
                    <div class="pd-review-rating">
                        {% for i in "12345" %}
                        <svg class="pd-star-sm {% if forloop.counter <= r.rating %}filled{% endif %}" viewBox="0 0 24 24"><path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ===== Sản phẩm liên quan ===== -->
    {% if related_products %}
    <div class="pd-extra-box" style="margin-top: 32px;">
        <h2 class="pd-extra-title">
            <svg width="22" height="22" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            Sản phẩm liên quan
        </h2>
        <div class="pd-related-body">
            <div class="qh-product-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px;">
                {% for rp in related_products %}
                <a href="{% url 'store:product_detail' rp.id %}" class="qh-product-card {% if rp.stock == 0 %}out-of-stock{% endif %}" style="text-decoration: none; color: inherit; display: block;">
                    <div class="qh-product-image" style="position: relative; aspect-ratio: 1; background: #f5f5f5; overflow: visible;">
                        {% if rp.image %}
                        <img src="{{ rp.image.url }}" alt="{{ rp.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--qh-text-light);">
                            <svg style="width: 64px; height: 64px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        {% endif %}

                        {% if rp.detail and rp.detail.summary_original_price and rp.detail.summary_original_price > rp.detail.discounted_price and rp.detail.summary_discount_percent > 0 %}
                        <div class="discount-badge">-{{ rp.detail.summary_discount_percent }}%</div>
                        {% endif %}

                        {% if rp.stock == 0 %}
                        <div class="out-of-stock-overlay"></div>
                        <span class="out-of-stock-badge">Hết hàng</span>
                        {% endif %}
                    </div>

                    <div class="qh-product-info" style="padding: 14px;">
                        <h3 class="qh-product-name" style="font-size: 18px; font-weight: 600; color: var(--qh-text); margin-bottom: 10px; line-height: 1.4; height: 25px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                            {{ rp.name }}
                        </h3>

                        <div class="qh-product-price" style="margin-bottom: 10px;">
                            {% if rp.detail and rp.detail.summary_original_price and rp.detail.summary_original_price > rp.detail.discounted_price and rp.detail.summary_discount_percent > 0 %}
                            <span style="font-size: 14px; color: var(--qh-text-light); text-decoration: line-through; display: block; margin-bottom: 2px;">
                                {{ rp.detail.summary_original_price|format_price_with_unit }}
                            </span>
                            <span style="font-size: 18px; font-weight: 700; color: var(--qh-primary);">
                                {{ rp.detail.discounted_price|format_price_with_unit }}
                            </span>
                            {% else %}
                            <span style="font-size: 18px; font-weight: 700; color: var(--qh-primary);">
                                {% if rp.detail %}{{ rp.detail.discounted_price|format_price_with_unit }}{% else %}{{ rp.price|format_price_with_unit }}{% endif %}
                            </span>
                            {% endif %}
                        </div>

                        <div style="display: flex; gap: 6px; margin-bottom: 12px;">
                            {% if rp.stock > 0 %}
                            <span style="font-size: 13px; color: #10b981; font-weight: 600; background: #d1fae5; padding: 4px 8px; border-radius: 4px; flex: 1; text-align: center;">Còn hàng</span>
                            <span style="font-size: 13px; color: #f59e0b; font-weight: 600; background: #fef3c7; padding: 4px 8px; border-radius: 4px; flex: 1; text-align: center;">Trả góp 0%</span>
                            {% else %}
                            <span style="font-size: 13px; color: #ef4444; font-weight: 600; background: #fee2e2; padding: 4px 8px; border-radius: 4px; flex: 1; text-align: center;">Hết hàng</span>
                            {% endif %}
                        </div>

                        <div style="display: flex; gap: 6px;">
                            <button class="qh-btn qh-btn-outline" style="flex: 1; padding: 8px 4px; font-size: 15px; border: 1px solid var(--qh-border); background: transparent; {% if rp.stock == 0 %}opacity: 0.5;{% endif %}">
                                Thêm vào so sánh
                            </button>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Product Content Panel (slide from right, y hệt Thông số kỹ thuật) -->
<div class="pd-spec-overlay" id="pdContentOverlay" onclick="closeContentModal(event)">
    <div class="pd-spec-panel" id="pdContentPanel" onclick="event.stopPropagation()">
        <div class="pd-spec-panel-header">
            <h2 class="pd-spec-panel-title">Thông tin sản phẩm</h2>
            <button class="pd-spec-panel-close" onclick="closeContentModalBtn()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="pd-spec-panel-body pd-content-body" id="pdContentModalBody">
            {% if product_content and product_content.content_text %}
                {{ product_content.content_text|safe }}
            {% else %}
                <p style="padding: 24px; color: #94a3b8; text-align: center; font-family: 'Signika', sans-serif;">Chưa có thông tin sản phẩm.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Spec Panel (slide from right) -->
<div class="pd-spec-overlay" id="pdSpecOverlay" onclick="closeSpecModal(event)">
    <div class="pd-spec-panel" id="pdSpecPanel" onclick="event.stopPropagation()">
        <div class="pd-spec-panel-header">
            <h2 class="pd-spec-panel-title">Thông số kỹ thuật</h2>
            <button class="pd-spec-panel-close" onclick="closeSpecModalBtn()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="pd-spec-tabs" id="pdSpecTabs"></div>
        <div class="pd-spec-panel-body" id="pdSpecModalBody"></div>
    </div>
</div>

<!-- Gallery Lightbox -->
<div class="pd-gallery-overlay" id="pdGalleryOverlay" onclick="closeGalleryOverlay(event)">
    <div class="pd-gallery-box" onclick="event.stopPropagation()">
        <div class="pd-gallery-color-tabs" id="pdGalleryColorTabs"></div>
        <div class="pd-gallery-main-area">
            <button class="pd-gallery-nav prev" onclick="galleryPrev()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <img class="pd-gallery-main-img" id="pdGalleryMainImg" src="" alt="" draggable="false">
            <button class="pd-gallery-nav next" onclick="galleryNext()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
        </div>
        <div class="pd-gallery-thumbs" id="pdGalleryThumbs"></div>
    </div>
</div>

<script>
const productId = {{ product.id }};
const variantsData = {{ variants_json|safe }};
const colorImagesData = {{ color_images_json|safe }};
const specData = {{ spec_data_json|safe }};
const productDescription = '{{ product.description|escapejs }}';
const hasProductContent = {% if product_content and product_content.content_text %}true{% else %}false{% endif %};
const youtubeVideoId = '{{ youtube_id|escapejs }}';
</script>

{% if youtube_id %}
<script>
var tag = document.createElement('script');
tag.src = 'https://www.youtube.com/iframe_api';
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

function onYouTubeIframeAPIReady() {
    new YT.Player('pdYoutubePlayer', {
        videoId: youtubeVideoId,
        playerVars: {
            'autoplay': 1,
            'mute': 1,
            'rel': 0,
            'modestbranding': 1,
            'playsinline': 1,
            'origin': window.location.origin
        },
        events: {
            'onReady': function(event) { event.target.playVideo(); }
        }
    });
}
</script>
{% endif %}
<script src="{% static 'js/pd_page.js' %}"></script>

{% if can_review %}
<script>
(function() {
    const stars = document.querySelectorAll('#pdReviewStars .pd-star-btn');
    const submitBtn = document.getElementById('pdReviewSubmitBtn');
    const msgEl = document.getElementById('pdReviewMsg');
    let selectedRating = 0;

    stars.forEach(star => {
        star.addEventListener('mouseenter', function() {
            const val = parseInt(this.dataset.value);
            stars.forEach((s, i) => s.classList.toggle('hover', i < val));
        });
        star.addEventListener('mouseleave', function() {
            stars.forEach((s, i) => s.classList.toggle('hover', false));
            stars.forEach((s, i) => s.classList.toggle('selected', i < selectedRating));
        });
        star.addEventListener('click', function() {
            selectedRating = parseInt(this.dataset.value);
            stars.forEach((s, i) => s.classList.toggle('selected', i < selectedRating));
            submitBtn.disabled = false;
        });
    });

    submitBtn.addEventListener('click', function() {
        if (!selectedRating) return;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang gửi...';

        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('rating', selectedRating);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}');

        fetch('{% url "store:submit_review" %}', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    msgEl.textContent = data.message;
                    msgEl.className = 'pd-review-msg success';
                    setTimeout(() => location.reload(), 800);
                } else {
                    msgEl.textContent = data.message;
                    msgEl.className = 'pd-review-msg error';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Gửi đánh giá';
                }
            })
            .catch(() => {
                msgEl.textContent = 'Có lỗi xảy ra, vui lòng thử lại.';
                msgEl.className = 'pd-review-msg error';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Gửi đánh giá';
            });
    });
})();
</script>
{% endif %}
{% endblock %}
